
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>makeit.retrosynthetic.mcts.tree_builder &#8212; ASKCOS 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for makeit.retrosynthetic.mcts.tree_builder</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">makeit.retrosynthetic.transformer</span> <span class="k">import</span> <span class="n">RetroTransformer</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.buyable.pricer</span> <span class="k">import</span> <span class="n">Pricer</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span><span class="p">,</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">celery.result</span> <span class="k">import</span> <span class="n">allow_join_result</span>
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="k">import</span> <span class="n">MongoClient</span>

<span class="c1"># from makeit.mcts.cost import Reset, score_max_depth, MinCost, BuyablePathwayCount</span>
<span class="c1"># from makeit.mcts.misc import get_feature_vec, save_sparse_tree</span>
<span class="c1"># from makeit.mcts.misc import value_network_training_states</span>
<span class="kn">from</span> <span class="nn">makeit.retrosynthetic.mcts.nodes</span> <span class="k">import</span> <span class="n">Chemical</span><span class="p">,</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">ChemicalTemplateApplication</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.io.logger</span> <span class="k">import</span> <span class="n">MyLogger</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.io</span> <span class="k">import</span> <span class="n">model_loader</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.formats</span> <span class="k">import</span> <span class="n">chem_dict</span><span class="p">,</span> <span class="n">rxn_dict</span>
<span class="kn">import</span> <span class="nn">askcos_site.askcos_celery.treebuilder.tb_c_worker</span> <span class="k">as</span> <span class="nn">tb_c_worker</span>
<span class="kn">import</span> <span class="nn">rdkit.Chem</span> <span class="k">as</span> <span class="nn">Chem</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">import</span> <span class="nn">makeit.global_config</span> <span class="k">as</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">is_py2</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span>
<span class="k">if</span> <span class="n">is_py2</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">VanillaQueue</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span> <span class="k">as</span> <span class="nn">VanillaQueue</span>
    <span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>

<span class="n">treebuilder_loc</span> <span class="o">=</span> <span class="s1">&#39;mcts_tree_builder&#39;</span>

<span class="n">VIRTUAL_LOSS</span> <span class="o">=</span> <span class="mi">1000000</span>

<span class="n">WAITING</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">DONE</span> <span class="o">=</span> <span class="mi">1</span>


<div class="viewcode-block" id="MCTS"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS">[docs]</a><span class="k">class</span> <span class="nc">MCTS</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class for retrosynthetic tree expansion using a depth-first search.</span>

<span class="sd">    Attributes:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retroTransformer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pricer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_branching</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">expansion_time</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                 <span class="n">celery</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mincount</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">RETRO_TRANSFORMS_CHIRAL</span><span class="p">[</span><span class="s1">&#39;mincount&#39;</span><span class="p">],</span>
                 <span class="n">mincount_chiral</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">RETRO_TRANSFORMS_CHIRAL</span><span class="p">[</span><span class="s1">&#39;mincount_chiral&#39;</span><span class="p">],</span>
                 <span class="n">template_prioritization</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">relevance</span><span class="p">,</span> <span class="n">precursor_prioritization</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">relevanceheuristic</span><span class="p">,</span>
                 <span class="n">chemhistorian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num_active_pathways</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialization of an object of the MCTS class.</span>

<span class="sd">        Sets default values for various settings and loads transformers as</span>
<span class="sd">        needed (i.e., based on whether Celery is being used or not).</span>
<span class="sd">        Most settings are overridden by the get_buyable_paths method anyway.</span>

<span class="sd">        Args:</span>
<span class="sd">            retroTransformer (None or RetroTransformer, optional):</span>
<span class="sd">                RetroTransformer object to be used for expansion when *not*</span>
<span class="sd">                using Celery. If None, will be initialized using the</span>
<span class="sd">                model_loader.load_Retro_Transformer function. (default: {None})</span>
<span class="sd">            pricer (None or Pricer, optional): Pricer object to be used for</span>
<span class="sd">                checking stop criteria (buyability). If None, will be</span>
<span class="sd">                initialized using default settings from the global</span>
<span class="sd">                configuration. (default: {None})</span>
<span class="sd">            max_branching (int, optional): Maximum number of precursor</span>
<span class="sd">                suggestions to add to the tree at each expansion.</span>
<span class="sd">                (default: {20})</span>
<span class="sd">            max_depth (int, optional): Maximum number of reactions to allow</span>
<span class="sd">                before stopping the recursive expansion down one branch.</span>
<span class="sd">                (default: {3})</span>
<span class="sd">            expansion_time (int, optional): Time (in seconds) to allow for</span>
<span class="sd">                expansion before searching the generated tree for buyable</span>
<span class="sd">                pathways. (default: {60})</span>
<span class="sd">            celery (bool, optional): Whether or not Celery is being used. If</span>
<span class="sd">                True, then the MCTS relies on reservable retrotransformer</span>
<span class="sd">                workers initialized separately. If False, then retrotransformer</span>
<span class="sd">                workers will be spun up using multiprocessing.</span>
<span class="sd">                (default: {False})</span>
<span class="sd">            nproc (int, optional): Number of retrotransformer processes to fork</span>
<span class="sd">                for faster expansion. (default: {1})</span>
<span class="sd">            mincount (int, optional): Minimum number of precedents for an</span>
<span class="sd">                achiral template for inclusion in the template library. Only</span>
<span class="sd">                used when retrotransformers need to be initialized.</span>
<span class="sd">                (default: {25})</span>
<span class="sd">            mincount_chiral (int, optional): Minimum number of precedents for a</span>
<span class="sd">                chiral template for inclusion in the template library. Only used</span>
<span class="sd">                when retrotransformers need to be initialized. Chiral templates</span>
<span class="sd">                are necessarily more specific, so we generally use a lower</span>
<span class="sd">                threshold than achiral templates. (default: {10})</span>
<span class="sd">            chiral (bool, optional): Whether or not to pay close attention to</span>
<span class="sd">                chirality. When False, even achiral templates can lead to</span>
<span class="sd">                accidental inversion of chirality in non-reacting parts of the</span>
<span class="sd">                molecule. It is highly recommended to keep this as True.</span>
<span class="sd">                (default: {True})</span>
<span class="sd">            template_prioritization (string, optional): Strategy used for</span>
<span class="sd">                template prioritization, as a string. There are a limited number</span>
<span class="sd">                of available options - consult the global configuration file for</span>
<span class="sd">                info. (default: {gc.popularity})</span>
<span class="sd">            precursor_prioritization (string, optional): Strategy used for</span>
<span class="sd">                precursor prioritization, as a string. There are a limited</span>
<span class="sd">                number of available options - consult the global configuration</span>
<span class="sd">                file for info. (default: {gc.heuristic})</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chiral</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;MCTS only works for chiral expansion!&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">celery</span> <span class="o">=</span> <span class="n">celery</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincount</span> <span class="o">=</span> <span class="n">mincount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincount_chiral</span> <span class="o">=</span> <span class="n">mincount_chiral</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_branching</span> <span class="o">=</span> <span class="n">max_branching</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_time</span> <span class="o">=</span> <span class="n">expansion_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_prioritization</span> <span class="o">=</span> <span class="n">template_prioritization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_prioritization</span> <span class="o">!=</span> <span class="n">gc</span><span class="o">.</span><span class="n">relevance</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot do MCTS without relevance template prioritization!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precursor_prioritization</span> <span class="o">=</span> <span class="n">precursor_prioritization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral</span> <span class="o">=</span> <span class="n">chiral</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cum_template_prob</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span> <span class="o">=</span> <span class="s1">&#39;plausibility&#39;</span>

        <span class="k">if</span> <span class="n">num_active_pathways</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_active_pathways</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span> <span class="o">=</span> <span class="n">num_active_pathways</span>

        <span class="c1">## Pricer</span>
        <span class="k">if</span> <span class="n">pricer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pricer</span> <span class="o">=</span> <span class="n">pricer</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pricer</span> <span class="o">=</span> <span class="n">Pricer</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pricer</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span> <span class="o">=</span> <span class="n">chemhistorian</span>
        <span class="k">if</span> <span class="n">chemhistorian</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">makeit.utilities.historian.chemicals</span> <span class="k">import</span> <span class="n">ChemHistorian</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span> <span class="o">=</span> <span class="n">ChemHistorian</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">refs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize vars, reset dicts, etc.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">soft_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># hard</span>


        <span class="c1"># Get template relevance model - need for target to get things started</span>
        <span class="c1"># NOTE: VERY IMPORTANT TO NOT USE TENSORFLOW!! OTHERWISE FORKED PROCESSES HANG</span>
        <span class="c1"># THIS SHOULD BE ABLE TO BE FIXED</span>
        <span class="kn">from</span> <span class="nn">makeit.prioritization.templates.relevance</span> <span class="k">import</span> <span class="n">RelevanceTemplatePrioritizer</span>
        <span class="n">template_prioritizer</span> <span class="o">=</span> <span class="n">RelevanceTemplatePrioritizer</span><span class="p">(</span><span class="n">use_tf</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">template_prioritizer</span><span class="o">.</span><span class="n">load_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_prioritizer</span> <span class="o">=</span> <span class="n">template_prioritizer</span>


        <span class="c1"># When not using Celery, need to ensure retroTransformer initialized</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retroTransformer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span> <span class="o">=</span> <span class="n">retroTransformer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span> <span class="o">=</span> <span class="n">model_loader</span><span class="o">.</span><span class="n">load_Retro_Transformer</span><span class="p">(</span><span class="n">mincount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">,</span>
                                                                            <span class="n">mincount_chiral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount_chiral</span><span class="p">,</span>
                                                                            <span class="n">chiral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">chiral</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">load_fast_filter</span><span class="p">()</span>
                <span class="c1"># don&#39;t load template prioritizer until later, TF doesn&#39;t like forking</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Still need to load to have num refs, etc.</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Loading transforms for informational purposes only&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span> <span class="o">=</span> <span class="n">RetroTransformer</span><span class="p">(</span><span class="n">mincount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount</span><span class="p">,</span> <span class="n">mincount_chiral</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mincount_chiral</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rxns</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;...done loading </span><span class="si">{}</span><span class="s1"> informational transforms!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">templates</span><span class="p">)),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>



        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">):</span> <span class="c1"># TODO: make Celery workers</span>
                <span class="sd">&quot;&quot;&quot;Adds pathway to be worked on with Celery.</span>

<span class="sd">                Args:</span>
<span class="sd">                    _id (int): ID of pending pathway.</span>
<span class="sd">                    smiles (str): SMILES string of molecule to be exanded.</span>
<span class="sd">                    template_idx (int): ID of template to apply to molecule.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Chiral transformation or heuristic prioritization requires</span>
                <span class="c1"># same database. _id is _id of active pathway</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb_c_worker</span><span class="o">.</span><span class="n">apply_one_template_by_idx</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;template_count&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_count</span><span class="p">,</span>
                            <span class="s1">&#39;max_cum_prob&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cum_template_prob</span><span class="p">,</span>
                            <span class="s1">&#39;apply_fast_filter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_fast_filter</span><span class="p">,</span>
                            <span class="s1">&#39;filter_threshold&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_threshold</span><span class="p">},</span>
                    <span class="c1"># queue=self.private_worker_queue, ## CWC TEST: don&#39;t reserve</span>
                <span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">WAITING</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Adds pathway to be worked on with multiprocessing.</span>

<span class="sd">                Args:</span>
<span class="sd">                    _id (int): ID of pending pathway.</span>
<span class="sd">                    smiles (str): SMILES string of molecule to be exanded.</span>
<span class="sd">                    template_idx (int): ID of template to apply to molecule.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">WAITING</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expand</span> <span class="o">=</span> <span class="n">expand</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Define method to start up parallelization.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">prepare</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;Starts parallelization with Celery.&quot;&quot;&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># if self.chiral:</span>
                    <span class="c1">#     request = tb_c_worker.reserve_worker_pool.delay()</span>
                    <span class="c1">#     self.private_worker_queue = request.get(timeout=10)</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     request = tb_worker.reserve_worker_pool.delay()</span>
                    <span class="c1">#     self.private_worker_queue = request.get(timeout=10)</span>

                    <span class="c1">## CWC TEST: don&#39;t reserve</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">tb_c_worker</span><span class="o">.</span><span class="n">apply_one_template_by_idx</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CCOC(=O)[C@H]1C[C@@H](C(=O)N2[C@@H](c3ccccc3)CC[C@@H]2c2ccccc2)[C@@H](c2ccccc2)N1&#39;</span><span class="p">,</span> <span class="mi">109659</span><span class="p">)</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                        <span class="s1">&#39;Did not find any workers? Try again later (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">prepare</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;Starts parallelization with multiprocessing.&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">:</span>
                    <span class="n">all_alive</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()):</span>
                            <span class="n">all_alive</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">all_alive</span><span class="p">:</span>
                        <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{}</span><span class="s1"> alive child processes, not generating new ones&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Tree builder spinning off </span><span class="si">{}</span><span class="s1"> child processes&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
                    <span class="c1"># p.daemon = True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">prepare</span>

        <span class="c1"># Define method to get a processed result.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_ready_result</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;Yields processed results from Celery.</span>

<span class="sd">                Yields:</span>
<span class="sd">                    list of 5-tuples of (int, string, int, list, float): Results</span>
<span class="sd">                        from workers after applying a template to a molecule.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Update which processes are ready</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">)</span> <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ready</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">forget</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">res</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ready</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">get_ready_result</span><span class="p">():</span>
                <span class="sd">&quot;&quot;&quot;Yields processed results from multiprocessing.</span>

<span class="sd">                Yields:</span>
<span class="sd">                    list of 5-tuples of (int, string, int, list, float): Results</span>
<span class="sd">                        from workers after applying a template to a molecule.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_ready_result</span> <span class="o">=</span> <span class="n">get_ready_result</span>

        <span class="c1"># QUESTION: Why is this method defined here and not in the class?</span>
        <span class="c1"># Define how first target is set.</span>
        <span class="k">def</span> <span class="nf">set_initial_target</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">leaves</span><span class="p">):</span> <span class="c1"># i = index of active pathway</span>
            <span class="sd">&quot;&quot;&quot;Sets the first target.</span>

<span class="sd">            Expands given molecules with given templates.</span>

<span class="sd">            Args:</span>
<span class="sd">                _id (int): Unused; passed through.</span>
<span class="sd">                leaves (list of 2-tuples of (str, int)): Pairs of molecule</span>
<span class="sd">                    SMILES and template IDs to be applied to them.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span> <span class="c1"># already being worked on</span>
                    <span class="k">continue</span>
                <span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span> <span class="o">=</span> <span class="n">leaf</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_target</span> <span class="o">=</span> <span class="n">set_initial_target</span>

        <span class="c1"># Define method to stop working.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">soft_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Stops work with Celery.</span>

<span class="sd">                Args:</span>
<span class="sd">                    soft_stop (bool, optional): Unused. (default: {false})</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span> <span class="o">!=</span> <span class="p">[]:</span> <span class="c1"># clear anything left over - might not be necessary</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">)):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">soft_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Stops work with multiprocessing.</span>

<span class="sd">                Args:</span>
<span class="sd">                    soft_stop (bool, optional): Whether to let active workers</span>
<span class="sd">                        continue. (default: {false})</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1">#MyLogger.print_and_log(&#39;Terminating tree building process.&#39;, treebuilder_loc)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">soft_stop</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="c1">#MyLogger.print_and_log(&#39;All tree building processes done.&#39;, treebuilder_loc)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>

    <span class="c1"># def get_price(self, chem_smi):</span>
    <span class="c1">#     ppg = self.pricer.lookup_smiles(chem_smi, alreadyCanonical=True)</span>
    <span class="c1">#     return ppg</span>
        <span class="c1"># if ppg:</span>
        <span class="c1">#   return 0.0</span>
        <span class="c1"># else:</span>
        <span class="c1">#   return None</span>

<div class="viewcode-block" id="MCTS.ResetVisitCount"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.ResetVisitCount">[docs]</a>    <span class="k">def</span> <span class="nf">ResetVisitCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resets visit count of chemicals and reactions to zero.</span>

<span class="sd">        Also empties successes and rewards for reactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">chem_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_key</span><span class="p">]</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rxn_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Reactions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions</span><span class="p">[</span><span class="n">rxn_key</span><span class="p">]</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions</span><span class="p">[</span><span class="n">rxn_key</span><span class="p">]</span><span class="o">.</span><span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions</span><span class="p">[</span><span class="n">rxn_key</span><span class="p">]</span><span class="o">.</span><span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="MCTS.coordinate"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.coordinate">[docs]</a>    <span class="k">def</span> <span class="nf">coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">known_bad_reactions</span><span class="o">=</span><span class="p">[],</span> <span class="n">forbidden_molecules</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Coordinates workers.</span>

<span class="sd">        Args:</span>
<span class="sd">            soft_stop (bool, optional): Whether to use softly stop the workers.</span>
<span class="sd">                (default: {False})</span>
<span class="sd">            known_bad_reactions (list of str, optional): Reactions to</span>
<span class="sd">                eliminate from output. (default: {[]})</span>
<span class="sd">            forbidden_molecules (list of str, optional): SMILES strings of</span>
<span class="sd">                molecules to eliminate from output. (default: {[]})</span>
<span class="sd">            return_first (bool, optional): Whether to return after finding first</span>
<span class="sd">                pathway. (default: {False})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">):</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Waiting for workers to initialize...&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Starting cooridnation loop&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_time</span><span class="p">):</span> <span class="c1"># and self.waiting_for_results():</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">)</span><span class="o">//</span><span class="mi">5</span> <span class="o">==</span> <span class="nb">next</span><span class="p">):</span>
                <span class="nb">next</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Worked for </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_time</span><span class="p">))</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;... current min-price </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">))</span>
                <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;... |C| = </span><span class="si">{}</span><span class="s2"> |R| = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Active pathway </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">[</span><span class="n">_id</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Active pathway pending? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pending results? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Expansion empty? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;results_queue empty? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All idle? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">))</span>

                <span class="c1"># print(self.expansion_queue.qsize()) # TODO: make this Celery compatible</span>
                <span class="c1"># print(self.results_queue.qsize())</span>

                <span class="c1"># for _id in range(self.nproc):</span>
                <span class="c1">#   print(_id, self.expansion_queues[_id].qsize(), self.results_queues[_id].qsize())</span>
                <span class="c1"># time.sleep(2)</span>

            <span class="k">for</span> <span class="n">all_outcomes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ready_result</span><span class="p">():</span>
                <span class="c1"># Record that we&#39;ve gotten a result for the _id of the active pathway</span>
                <span class="n">_id</span> <span class="o">=</span> <span class="n">all_outcomes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(&#39;coord got outcomes for pathway ID {}&#39;.format(_id))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

                <span class="c1"># Result of applying one template_idx to one chem_smi can be multiple eoutcomes</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">filter_score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">all_outcomes</span><span class="p">:</span>
                    <span class="c1"># print(&#39;coord pulled {} result from result queue&#39;.format(chem_smi))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="n">DONE</span>
                    <span class="c1"># R = self.Chemicals[chem_smi].reactions[template_idx]</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
                    <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span> <span class="c1"># TODO: make sure CTA created</span>
                    <span class="n">CTA</span><span class="o">.</span><span class="n">waiting</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Any proposed reactants?</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactants</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">CTA</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># no precursors, reaction failed</span>
                        <span class="c1"># print(&#39;No reactants found for {} {}&#39;.format(_id, chem_smi))</span>
                        <span class="k">continue</span>

                    <span class="c1"># Get reactants SMILES</span>
                    <span class="n">reactant_smiles</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">smi</span> <span class="k">for</span> <span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reactants</span><span class="p">])</span>

                    <span class="c1"># Banned reaction?</span>
                    <span class="k">if</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&gt;&gt;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">reactant_smiles</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">)</span> <span class="ow">in</span> <span class="n">known_bad_reactions</span><span class="p">:</span>
                        <span class="n">CTA</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>

                    <span class="c1"># Banned molecule?</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">smi</span> <span class="ow">in</span> <span class="n">forbidden_molecules</span> <span class="k">for</span> <span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reactants</span><span class="p">):</span>
                        <span class="n">CTA</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>

                    <span class="c1"># TODO: check if banned reaction</span>
                    <span class="n">matched_prev</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">prev_tid</span><span class="p">,</span> <span class="n">prev_cta</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">reactant_smiles</span> <span class="ow">in</span> <span class="n">prev_cta</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                            <span class="n">prev_R</span> <span class="o">=</span> <span class="n">prev_cta</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactant_smiles</span><span class="p">]</span>
                            <span class="n">matched_prev</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># Now merge the two...</span>
                            <span class="n">prev_R</span><span class="o">.</span><span class="n">tforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">template_idx</span><span class="p">)</span>
                            <span class="n">prev_R</span><span class="o">.</span><span class="n">template_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">prob</span><span class="p">[</span><span class="n">template_idx</span><span class="p">],</span> <span class="n">prev_R</span><span class="o">.</span><span class="n">template_score</span><span class="p">)</span>
                            <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactant_smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_R</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">matched_prev</span><span class="p">:</span>
                        <span class="k">continue</span> <span class="c1"># don&#39;t make a new reaction</span>

                    <span class="c1"># Define reaction using product SMILES, template_idx, and reactants SMILES</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">plausibility</span> <span class="o">=</span> <span class="n">filter_score</span> <span class="c1"># fast filter score</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">template_score</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">prob</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span> <span class="c1"># template relevance</span>
                    <span class="c1">#for smi, prob, value in reactants:</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">top_probs</span><span class="p">,</span> <span class="n">top_indeces</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">reactants</span><span class="p">:</span> <span class="c1"># all precursors</span>
                        <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">smi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chemical</span><span class="p">(</span><span class="n">smi</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">set_template_relevance_probs</span><span class="p">(</span><span class="n">top_probs</span><span class="p">,</span> <span class="n">top_indeces</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

                            <span class="n">ppg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricer</span><span class="o">.</span><span class="n">lookup_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">alreadyCanonical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">purchase_price</span> <span class="o">=</span> <span class="n">ppg</span>
                            <span class="c1"># if ppg is not None and ppg &gt; 0:</span>
                            <span class="c1">#     self.Chemicals[smi].set_price(ppg)</span>

                            <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span><span class="o">.</span><span class="n">lookup_smiles</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">alreadyCanonical</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">as_reactant</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_reactant&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">as_product</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_product&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_a_terminal_node</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">set_price</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># all nodes treated the same for now</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># print(&#39;TERMINAL: {}&#39;.format(self.Chemicals[smi]))# DEBUG</span>

                    <span class="n">R</span><span class="o">.</span><span class="n">estimate_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">estimate_price</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">])</span>

                    <span class="c1"># Add this reaction result to CTA (key = reactant smiles)</span>
                    <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactant_smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>

            <span class="c1"># See if this rollout is done (TODO: make this Celery compatible)</span>
            <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># this expansion step is done</span>
                    <span class="c1"># This expansion step is done = record!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">[</span><span class="n">_id</span><span class="p">])</span>

                    <span class="c1"># Set new target</span>
                    <span class="n">leaves</span><span class="p">,</span> <span class="n">pathway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_leaf</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathway</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_target</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">leaves</span><span class="p">)</span>


            <span class="c1"># if self.expansion_queue.empty() and self.results_queue.empty() and all(self.idle):</span>
            <span class="c1">#     # print(&#39;All idle and queues empty&#39;)</span>
            <span class="c1">#     self.update(self.smiles, self.active_pathway)</span>
            <span class="c1">#     self.active_pathway = {}</span>

            <span class="c1"># Set new target (THIS IS OLD)</span>
            <span class="c1"># if len(self.active_pathway) == 0:</span>
            <span class="c1">#     # print(&#39;Finding a new active pathway&#39;)</span>
            <span class="c1">#     leaves, pathway = self.select_leaf()</span>
            <span class="c1">#     self.active_pathway = pathway</span>
            <span class="c1">#     self.set_initial_target(leaves)</span>

            <span class="c1"># for _id in range(self.nproc):</span>
            <span class="c1">#     if self.expansion_queues[_id].empty() and self.results_queues[_id].empty() and self.idle[_id]:</span>
            <span class="c1">#         self.update(self.smiles, self.pathways[_id])</span>
            <span class="c1">#         self.pathways[_id] = {}</span>

            <span class="c1"># for _id in range(self.nproc):</span>
            <span class="c1">#     if len(self.pathways[_id]) == 0:</span>
            <span class="c1">#         leaves, pathway = self.select_leaf()</span>
            <span class="c1">#         # if len(self.Chemicals) &gt; 30:</span>
            <span class="c1">#         # print(&#39;###############&#39;, _id, leaves, pathway)</span>
            <span class="c1">#         self.pathways[_id] = pathway</span>
            <span class="c1">#         self.set_initial_target(_id, leaves)</span>

            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_for_first_path</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time_for_first_path</span> <span class="o">=</span> <span class="n">elapsed_time</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Found the first pathway after </span><span class="si">{:.2f}</span><span class="s1"> seconds&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_first</span><span class="p">:</span>
                    <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Stoping expansion to return first pathway as requested&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span>  <span class="nb">all</span><span class="p">(</span><span class="n">pathway</span> <span class="o">==</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">pathway</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Cannot expand any further! Stuck?&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">soft_stop</span><span class="o">=</span><span class="n">soft_stop</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">[</span><span class="n">_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">)]</span></div>
        <span class="c1"># print(self.active_pathway)</span>

<div class="viewcode-block" id="MCTS.work"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.work">[docs]</a>    <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns work (if available) to given worker.</span>

<span class="sd">        Args:</span>
<span class="sd">            i (int): Index of worker to be assigned work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># with tf.device(&#39;/gpu:%d&#39; % (i % self.ngpus)):</span>
        <span class="c1">#     self.model = RLModel()</span>
        <span class="c1">#     self.model.load(MODEL_PATH)</span>

        <span class="c1"># Load models that are required</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">get_template_prioritizers</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">relevance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># If done, stop</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="c1"># print &#39;Worker {} saw done signal, terminating&#39;.format(i)</span>
                <span class="k">break</span>

            <span class="c1"># Grab something off the queue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># short timeout</span>

                    <span class="c1"># print(&#39;{} grabbed {} and {} from queue&#39;.format(_id, smiles, template_idx))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">all_outcomes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">apply_one_template_by_idx</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)</span> <span class="c1"># TODO: add settings</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="n">all_outcomes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">,</span> <span class="p">[],</span> <span class="mf">0.0</span><span class="p">)]</span>
                    <span class="c1"># print(&#39;{} applied one template and got {}&#39;.format(i, all_outcomes))</span>
                    <span class="c1"># all_outcomes = list of (_id, smiles, template_idx, reactants, filter_score)</span>


                    <span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">all_outcomes</span><span class="p">)</span>
                    <span class="c1"># print(&#39;{} put {} outcomes on queue&#39;.format(i, len(all_outcomes)))</span>

                <span class="k">except</span> <span class="n">VanillaQueue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">pass</span> <span class="c1"># looks like someone got there first...</span>


            <span class="c1"># time.sleep(0.01)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="MCTS.UCB"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.UCB">[docs]</a>    <span class="k">def</span> <span class="nf">UCB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">,</span> <span class="n">c_exploration</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;Finds best reaction for a given chemical.</span>

<span class="sd">        Can either select an unapplied template to apply, or select a specific</span>
<span class="sd">        reactant to expand further (?)</span>
<span class="sd">        TODO: check these changes...</span>

<span class="sd">        Args:</span>
<span class="sd">            chem_smi (str): SMILES string of target chemical.</span>
<span class="sd">            c_exploration (float, optional): ?? Used to calculate reaction</span>
<span class="sd">                score. (default: {0.2})</span>
<span class="sd">            path (list or dict, optional): Current reation path. (default: {[]})</span>

<span class="sd">        Returns:</span>
<span class="sd">            2-tuple of (int, str): Index of template and SMILES strings of</span>
<span class="sd">                reactants corresponding to the highest scoring reaction</span>
<span class="sd">                resulting in the target product.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rxn_scores</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
        <span class="n">product_visits</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">visit_count</span>
        <span class="n">max_estimate_price</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">template_idx</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">:</span>
            <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">CTA</span><span class="o">.</span><span class="n">waiting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">CTA</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">reactants_smi</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactants_smi</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># avoid cycles</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">max_estimate_price</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_estimate_price</span><span class="p">,</span> <span class="n">R</span><span class="o">.</span><span class="n">estimate_price</span><span class="p">)</span>
                <span class="n">Q_sa</span> <span class="o">=</span> <span class="o">-</span> <span class="n">R</span><span class="o">.</span><span class="n">estimate_price</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">U_sa</span> <span class="o">=</span> <span class="n">c_exploration</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">prob</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">product_visits</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">product_visits</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">Q_sa</span> <span class="o">+</span> <span class="n">U_sa</span>
                <span class="n">rxn_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">))</span>

        <span class="c1"># unexpanded template - find most relevant template that hasn&#39;t been tried</span>
        <span class="n">num_branches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn_scores</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_branches</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_branching</span> <span class="ow">or</span> <span class="n">chem_smi</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">template_idx</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">top_indeces</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">template_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">:</span>
                    <span class="n">Q_sa</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_estimate_price</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">U_sa</span> <span class="o">=</span> <span class="n">c_exploration</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">prob</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">product_visits</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">Q_sa</span> <span class="o">+</span> <span class="n">U_sa</span>
                    <span class="n">rxn_scores</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">score</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="c1"># record estimated score if we were to actually apply that template</span>
                    <span class="c1"># TODO: figure out if this &quot;None&quot; makes sense for the reactants smiles</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sorted_rxn_scores</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rxn_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">best_rxn_score</span><span class="p">,</span> <span class="n">selected_template_idx</span><span class="p">,</span> <span class="n">selected_reactants_smi</span> <span class="o">=</span> <span class="n">sorted_rxn_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># get next best template to apply</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_template_idx</span><span class="p">,</span> <span class="n">selected_reactants_smi</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">selected_template_idx</span><span class="p">,</span> <span class="n">selected_reactants_smi</span></div>


<div class="viewcode-block" id="MCTS.select_leaf"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.select_leaf">[docs]</a>    <span class="k">def</span> <span class="nf">select_leaf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c_exploration</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds reaction pathways??</span>

<span class="sd">        Args:</span>
<span class="sd">            c_exploration (float, optional): ?? (default: {1.0})</span>

<span class="sd">        Returns:</span>
<span class="sd">            2-tuple of (list of 2-tuples of (str, int), dict): SMILES strings of</span>
<span class="sd">                chemical and corresponding template index and pathways from a</span>
<span class="sd">                chemical to its reactants??</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#start_time = time.time()</span>
        <span class="n">pathway</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">leaves</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">VanillaQueue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]))</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">chem_smi</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">or</span> <span class="n">chem_smi</span> <span class="ow">in</span> <span class="n">pathway</span><span class="p">:</span> <span class="c1"># don&#39;t go too deep or recursively</span>
                <span class="k">continue</span>
            <span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UCB</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">c_exploration</span><span class="o">=</span><span class="n">c_exploration</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">template_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Only grow pathway when we have picked a specific reactants_smi (?)</span>
            <span class="k">if</span> <span class="n">reactants_smi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pathway</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">)</span> <span class="c1"># TODO: figure out if reactants_smi==None case is an issue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pathway</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span> <span class="o">=</span> <span class="n">template_idx</span> <span class="c1"># still record template selection</span>

            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
            <span class="n">C</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">+=</span> <span class="n">VIRTUAL_LOSS</span>

            <span class="c1"># print(&#39;Looking at chemical C: {}&#39;.format(C))</span>
            <span class="k">if</span> <span class="n">template_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">:</span>
                <span class="c1"># print(&#39;Creating CTA for {} and {}&#39;.format(chem_smi, template_idx))</span>
                <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ChemicalTemplateApplication</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">)</span>
                <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>

                <span class="c1"># TODO: figure out VIRTUAL_LOSS for R.visit_count change?</span>
                <span class="c1"># C.reactions[template_idx] = Reaction(chem_smi, template_idx)</span>
                <span class="c1"># R = C.reactions[template_idx]</span>
                <span class="c1"># R.visit_count += VIRTUAL_LOSS</span>
                <span class="n">leaves</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Can we assume that the reactants_smi exists in this CTA? I guess so...</span>
                <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">reactants_smi</span><span class="p">:</span> <span class="c1"># if we choose a specific reaction, not just a template...</span>
                    <span class="k">if</span> <span class="n">reactants_smi</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>

                        <span class="n">R</span> <span class="o">=</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactants_smi</span><span class="p">]</span>
                        <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">+=</span> <span class="n">VIRTUAL_LOSS</span>

                        <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">:</span>
                            <span class="k">assert</span> <span class="n">smi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span>
                            <span class="c1"># if self.Chemicals[smi].purchase_price == -1:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                                <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">smi</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="p">[</span><span class="n">smi</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                            <span class="n">C</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">+=</span> <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span>
                            <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">+=</span> <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span>

        <span class="k">return</span> <span class="n">leaves</span><span class="p">,</span> <span class="n">pathway</span></div>


<div class="viewcode-block" id="MCTS.update"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">,</span> <span class="n">pathway</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;??</span>

<span class="sd">        Args:</span>
<span class="sd">            chem_smi (str): SMILES string of</span>
<span class="sd">            pathway (dict):</span>
<span class="sd">            depth (int, optional): (default: {0})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">pathway</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pathway</span><span class="p">[</span><span class="n">smi</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">)</span> <span class="o">=</span> <span class="n">pathway</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pathway</span><span class="p">[</span><span class="n">smi</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span>
                <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>
                <span class="n">C</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">-=</span> <span class="p">(</span><span class="n">VIRTUAL_LOSS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reactants_smi</span><span class="p">:</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactants_smi</span><span class="p">]</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">visit_count</span> <span class="o">-=</span> <span class="p">(</span><span class="n">VIRTUAL_LOSS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">chem_smi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pathway</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pathway</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="p">(</span><span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">)</span> <span class="o">=</span> <span class="n">pathway</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">template_idx</span><span class="p">,</span> <span class="n">reactants_smi</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">pathway</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
        <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">CTA</span><span class="o">.</span><span class="n">waiting</span><span class="p">:</span> <span class="c1"># haven&#39;t actually expanded</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">reactants_smi</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactants_smi</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">valid</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">R</span><span class="o">.</span><span class="n">done</span><span class="p">):</span>
                <span class="n">R</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">done</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">])</span>

                <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">pathway</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">estimate_price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">estimate_price</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">])</span>
                <span class="n">R</span><span class="o">.</span><span class="n">update_estimate_price</span><span class="p">(</span><span class="n">estimate_price</span><span class="p">)</span>
                <span class="n">C</span><span class="o">.</span><span class="n">update_estimate_price</span><span class="p">(</span><span class="n">estimate_price</span><span class="p">)</span>

                <span class="n">price_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">price</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">price_list</span><span class="p">]):</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">price_list</span><span class="p">)</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
                    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="ow">or</span> <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">price</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span> <span class="k">for</span> <span class="n">tid</span><span class="p">,</span><span class="n">CTA</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_branching</span><span class="p">:</span>
            <span class="c1"># print(&#39;{} hit max branching, checking if &quot;done&quot;&#39;.format(chem_smi))</span>
            <span class="n">C</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([(</span><span class="n">R</span><span class="o">.</span><span class="n">done</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">R</span><span class="o">.</span><span class="n">valid</span><span class="p">))</span> <span class="k">for</span> <span class="n">rsmi</span><span class="p">,</span><span class="n">R</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">tid</span><span class="p">,</span><span class="n">CTA</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span></div>

        <span class="c1"># if C.price != -1 and C.price &lt; C.estimate_price:</span>
        <span class="c1">#   C.estimate_price = C.price</span>


<div class="viewcode-block" id="MCTS.full_update"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.full_update">[docs]</a>    <span class="k">def</span> <span class="nf">full_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chem_smi</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;??</span>

<span class="sd">        Args:</span>
<span class="sd">            chem_smi (str): SMILES string of target chemical.</span>
<span class="sd">            depth (int, optional): (default: {0})</span>
<span class="sd">            path (list?): (default: {[]})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
        <span class="n">C</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">C</span><span class="o">.</span><span class="n">terminal</span><span class="p">:</span>
            <span class="n">C</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;    &#39;</span><span class="o">*</span> <span class="n">depth</span>

        <span class="k">for</span> <span class="n">template_idx</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">:</span>
            <span class="n">CTA</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">reactants_smi</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">reactants_smi</span><span class="p">]</span>
                <span class="n">R</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">R</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">full_update</span><span class="p">(</span><span class="n">smi</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">path</span><span class="o">+</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">])</span>
                <span class="n">price_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">price</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">price</span> <span class="ow">in</span> <span class="n">price_list</span><span class="p">]):</span>
                    <span class="n">price</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">price_list</span><span class="p">)</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
                    <span class="k">if</span> <span class="n">R</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="ow">or</span> <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">C</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">price</span>
                        <span class="n">C</span><span class="o">.</span><span class="n">best_template</span> <span class="o">=</span> <span class="n">template_idx</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">pathway_count</span> <span class="k">for</span> <span class="n">smi</span> <span class="ow">in</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">])</span>
                    <span class="c1"># if R.pathway_count != 0:</span>
                    <span class="c1">#   print(prefix + &#39;  Reac %d: &#39;%template_idx + str(R.reactant_smiles) + &#39; %d paths&#39;%R.pathway_count)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># print(prefix + str(R.reactant_smiles) + &#39; - %d&#39; % R.pathway_count)</span>

        <span class="n">C</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tid</span><span class="p">,</span><span class="n">CTA</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rct_smi</span><span class="p">,</span><span class="n">R</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">C</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">+=</span> <span class="n">R</span><span class="o">.</span><span class="n">pathway_count</span></div>

        <span class="c1"># if C.pathway_count != 0:</span>
        <span class="c1">#   print(prefix + chem_smi + &#39; %d paths, price: %.1f&#39; % (C.pathway_count, C.price))</span>


<div class="viewcode-block" id="MCTS.build_tree"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.build_tree">[docs]</a>    <span class="k">def</span> <span class="nf">build_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">known_bad_reactions</span><span class="o">=</span><span class="p">[],</span> <span class="n">forbidden_molecules</span><span class="o">=</span><span class="p">[],</span> <span class="n">return_first</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds retrosynthesis tree.</span>

<span class="sd">        Args:</span>
<span class="sd">            soft_stop (bool, optional): Whether to use softly stop the workers.</span>
<span class="sd">                (default: {False})</span>
<span class="sd">            known_bad_reactions (list of str, optional): Reactions to</span>
<span class="sd">                eliminate from output. (default: {[]})</span>
<span class="sd">            forbidden_molecules (list of str, optional): SMILES strings of</span>
<span class="sd">                molecules to eliminate from output. (default: {[]})</span>
<span class="sd">            return_first (bool, optional): Whether to return after finding first</span>
<span class="sd">                pathway. (default: {False})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">celery.result</span> <span class="k">import</span> <span class="n">allow_join_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">makeit.utilities.with_dummy</span> <span class="k">import</span> <span class="n">with_dummy</span> <span class="k">as</span> <span class="n">allow_join_result</span>

        <span class="k">with</span> <span class="n">allow_join_result</span><span class="p">():</span>

            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Preparing workers...&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

            <span class="c1"># Define first chemical node (target)</span>
            <span class="n">probs</span><span class="p">,</span> <span class="n">indeces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_prioritizer</span><span class="o">.</span><span class="n">get_topk_from_smi</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template_count</span><span class="p">)</span>
            <span class="n">truncate_to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cum_template_prob</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">truncate_to</span><span class="p">):</span>
                <span class="n">truncate_to</span> <span class="o">=</span> <span class="n">truncate_to</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Truncate based on max_cum_prob?</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">truncate_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_count</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># current value assigned to precursor (note: may replace with real value function)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chemical</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">set_template_relevance_probs</span><span class="p">(</span><span class="n">probs</span><span class="p">[:</span><span class="n">truncate_to</span><span class="p">],</span> <span class="n">indeces</span><span class="p">[:</span><span class="n">truncate_to</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Calculating initial probs for target&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span><span class="o">.</span><span class="n">lookup_smiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">alreadyCanonical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">as_reactant</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_reactant&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">as_product</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_product&#39;</span><span class="p">]</span>
            <span class="n">ppg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pricer</span><span class="o">.</span><span class="n">lookup_smiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">alreadyCanonical</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">purchase_price</span> <span class="o">=</span> <span class="n">ppg</span>

            <span class="c1"># First selection is all the same</span>
            <span class="n">leaves</span><span class="p">,</span> <span class="n">pathway</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_leaf</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathway</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_target</span><span class="p">(</span><span class="n">_id</span><span class="p">,</span> <span class="n">leaves</span><span class="p">)</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Set initial leaves for active pathways&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>

            <span class="c1"># Coordinate workers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">(</span><span class="n">soft_stop</span><span class="o">=</span><span class="n">soft_stop</span><span class="p">,</span> <span class="n">known_bad_reactions</span><span class="o">=</span><span class="n">known_bad_reactions</span><span class="p">,</span>
                <span class="n">forbidden_molecules</span><span class="o">=</span><span class="n">forbidden_molecules</span><span class="p">,</span> <span class="n">return_first</span><span class="o">=</span><span class="n">return_first</span><span class="p">)</span>

            <span class="c1"># Do a final pass to get counts</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Doing final update of pathway counts / prices&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">full_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished working.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== found </span><span class="si">%d</span><span class="s2"> pathways (overcounting duplicate templates)&quot;</span> <span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="n">pathway_count</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== time for fist pathway: </span><span class="si">%.2f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_for_first_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== min price: </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">C</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="c1"># self.Chemicals, C.pathway_count, self.time_for_first_path</span></div>

    <span class="c1"># QUESTION: Why return the empty list?</span>
<div class="viewcode-block" id="MCTS.tree_status"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.tree_status">[docs]</a>    <span class="k">def</span> <span class="nf">tree_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summarize size of tree after expansion.</span>

<span class="sd">        Returns:</span>
<span class="sd">            num_chemicals (int): Number of chemical nodes in the tree.</span>
<span class="sd">            num_reactions (int): Number of reaction nodes in the tree.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">num_chemicals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">)</span>
        <span class="n">num_reactions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">num_chemicals</span><span class="p">,</span> <span class="n">num_reactions</span><span class="p">,</span> <span class="p">[])</span></div>


<div class="viewcode-block" id="MCTS.reset"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepare for a new expansion</span>

<span class="sd">        TODO: add &quot;soft&quot; feature which does not spin up new workers</span>

<span class="sd">        Args:</span>
<span class="sd">            soft_reset (bool, optional): Whether to do a soft reset.</span>
<span class="sd">                (default: {False})</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">celery</span><span class="p">:</span>
            <span class="c1"># general parameters in celery format</span>
            <span class="c1"># TODO: anything goes here?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">soft_reset</span><span class="p">:</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Doing a hard worker reset&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">Value</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Doing a soft worker reset&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">VanillaQueue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">results_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">VanillaQueue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_pathways_pending</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pathway_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincost</span> <span class="o">=</span> <span class="mf">10000.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Reactions</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># new</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_for_first_path</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="MCTS.return_trees"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.return_trees">[docs]</a>    <span class="k">def</span> <span class="nf">return_trees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns retrosynthetic pathways trees and their size.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">cheminfodict</span><span class="p">(</span><span class="n">smi</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns dict of extra info about a given chemical.</span>

<span class="sd">            Args:</span>
<span class="sd">                smi (str): SMILES string of chemical.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;smiles&#39;</span><span class="p">:</span> <span class="n">smi</span><span class="p">,</span>
                <span class="s1">&#39;ppg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">purchase_price</span><span class="p">,</span>
                <span class="s1">&#39;as_reactant&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">as_reactant</span><span class="p">,</span>
                <span class="s1">&#39;as_product&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span><span class="o">.</span><span class="n">as_product</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">tidlisttoinfodict</span><span class="p">(</span><span class="n">tids</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Returns dict of info from a given list of templates.</span>

<span class="sd">                Args:</span>
<span class="sd">                    tids (list of int): Template IDs to get info about.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;tforms&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="s1">&#39;_id&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tids</span><span class="p">],</span>
                <span class="s1">&#39;num_examples&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">tid</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">tid</span> <span class="ow">in</span> <span class="n">tids</span><span class="p">])),</span>
                <span class="s1">&#39;necessary_reagent&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">retroTransformer</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">tids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;necessary_reagent&#39;</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="n">seen_rxnsmiles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">def</span> <span class="nf">rxnsmiles_to_id</span><span class="p">(</span><span class="n">smi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">smi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_rxnsmiles</span><span class="p">:</span>
                <span class="n">seen_rxnsmiles</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">seen_rxnsmiles</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span>
        <span class="n">seen_chemsmiles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span> <span class="nf">chemsmiles_to_id</span><span class="p">(</span><span class="n">smi</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">smi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_chemsmiles</span><span class="p">:</span>
                <span class="n">seen_chemsmiles</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">seen_chemsmiles</span><span class="p">[</span><span class="n">smi</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">IDDFS</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;Performs iterative depth-first search to find buyable pathways.</span>

<span class="sd">            Yields:</span>
<span class="sd">                dict: nested dictionaries defining synthesis trees</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">headNode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smiles</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">DLS_chem</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">headNode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Expands at a fixed depth for the current node chem_id.</span>

<span class="sd">            Args:</span>
<span class="sd">                chem_smi (str): SMILES string for given chemical.</span>
<span class="sd">                depth (int): Depth node is expanded at.</span>
<span class="sd">                headNode (bool, optional): Unused. (default: {False})</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">C</span><span class="o">.</span><span class="n">terminal</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">done_children_of_this_chemical</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tid</span><span class="p">,</span> <span class="n">CTA</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">template_idx_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">CTA</span><span class="o">.</span><span class="n">waiting</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">rct_smi</span><span class="p">,</span> <span class="n">R</span> <span class="ow">in</span> <span class="n">CTA</span><span class="o">.</span><span class="n">reactions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">R</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span> <span class="ow">or</span> <span class="n">R</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">rxn_smiles</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&gt;&gt;&#39;</span> <span class="o">+</span> <span class="n">chem_smi</span>
                    <span class="k">if</span> <span class="n">rxn_smiles</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done_children_of_this_chemical</span><span class="p">:</span> <span class="c1"># necessary to avoid duplicates</span>
                        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">DLS_rxn</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">rct_smi</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">[</span><span class="n">rxn_dict</span><span class="p">(</span><span class="n">rxnsmiles_to_id</span><span class="p">(</span><span class="n">rxn_smiles</span><span class="p">),</span> <span class="n">rxn_smiles</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                <span class="n">plausibility</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">plausibility</span><span class="p">,</span>
                                <span class="n">template_score</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">template_score</span><span class="p">,</span> <span class="o">**</span><span class="n">tidlisttoinfodict</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">tforms</span><span class="p">))]</span>
                            <span class="c1"># TODO: figure out when to include num_examples</span>
                        <span class="n">done_children_of_this_chemical</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_smiles</span><span class="p">)</span>


        <span class="k">def</span> <span class="nf">DLS_rxn</span><span class="p">(</span><span class="n">chem_smi</span><span class="p">,</span> <span class="n">template_idx</span><span class="p">,</span> <span class="n">rct_smi</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Yields children paths starting from a specific rxn_id.</span>

<span class="sd">            Args:</span>
<span class="sd">                chem_smi (str): SMILES string for given chemical.</span>
<span class="sd">                template_idx (int): Index of given template.</span>
<span class="sd">                rct_smi (str): SMILES string for reactants.</span>
<span class="sd">                depth (int): depth of given reaction.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># TODO: add in auxiliary information about templates, etc.</span>
            <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">chem_smi</span><span class="p">]</span><span class="o">.</span><span class="n">template_idx_results</span><span class="p">[</span><span class="n">template_idx</span><span class="p">]</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">rct_smi</span><span class="p">]</span>

            <span class="c1"># rxn_list = []</span>
            <span class="c1"># for smi in R.reactant_smiles:</span>
            <span class="c1">#     rxn_list.append([chem_dict(smi, children=path, **{}) for path in DLS_chem(smi, depth+1)])</span>

            <span class="c1"># return [rxns[0] for rxns in itertools.product(rxn_list)]</span>

            <span class="c1">###################</span>
            <span class="c1"># To get recursion working properly with generators, need to hard-code these cases? Unclear</span>
            <span class="c1"># whether itertools.product can actually work with generators. Seems like it can&#39;t work</span>
            <span class="c1"># well...</span>

            <span class="c1"># Only one reactant? easy!</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">chem_smi0</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="p">[</span>
                        <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">))</span>
                    <span class="p">]</span>

            <span class="c1"># Two reactants? want to capture all combinations of each node&#39;s</span>
            <span class="c1"># options</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">chem_smi0</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chem_smi1</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">path0</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">path1</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="p">[</span>
                            <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path0</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">)),</span>
                            <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path1</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">)),</span>
                        <span class="p">]</span>

            <span class="c1"># Three reactants? This is not elegant...</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">chem_smi0</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chem_smi1</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">chem_smi2</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">path0</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">path1</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">path2</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">yield</span> <span class="p">[</span>
                                <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path0</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">)),</span>
                                <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path1</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">)),</span>
                                <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">)),</span>
                            <span class="p">]</span>

            <span class="c1"># I am ashamed</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">chem_smi0</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">chem_smi1</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">chem_smi2</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">chem_smi3</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">path0</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">path1</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">path2</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">path3</span> <span class="ow">in</span> <span class="n">DLS_chem</span><span class="p">(</span><span class="n">chem_smi3</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="k">yield</span> <span class="p">[</span>
                                    <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path0</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi0</span><span class="p">)),</span>
                                    <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path1</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi1</span><span class="p">)),</span>
                                    <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path2</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi2</span><span class="p">)),</span>
                                    <span class="n">chem_dict</span><span class="p">(</span><span class="n">chemsmiles_to_id</span><span class="p">(</span><span class="n">chem_smi3</span><span class="p">),</span> <span class="n">children</span><span class="o">=</span><span class="n">path3</span><span class="p">,</span> <span class="o">**</span><span class="n">cheminfodict</span><span class="p">(</span><span class="n">chem_smi3</span><span class="p">)),</span>
                                <span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many reactants! Only have cases 1-4 programmed&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There probably are not any real 5 component reactions&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">reactant_smiles</span><span class="p">)</span>


        <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Retrieving trees...&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
        <span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">IDDFS</span><span class="p">():</span>
            <span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_trees</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Sort by some metric</span>
        <span class="k">def</span> <span class="nf">number_of_starting_materials</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tree</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">number_of_starting_materials</span><span class="p">(</span><span class="n">tree_child</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree_child</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">def</span> <span class="nf">number_of_reactions</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tree</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">number_of_reactions</span><span class="p">(</span><span class="n">tree_child</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree_child</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;children&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">def</span> <span class="nf">overall_plausibility</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tree</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
                    <span class="n">producing_reaction</span> <span class="o">=</span> <span class="n">tree</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">producing_reaction</span><span class="p">[</span><span class="s1">&#39;plausibility&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">overall_plausibility</span><span class="p">(</span><span class="n">tree_child</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree_child</span> <span class="ow">in</span> <span class="n">producing_reaction</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]])</span>
            <span class="k">return</span> <span class="mf">1.0</span>

        <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Sorting </span><span class="si">{}</span><span class="s1"> trees...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trees</span><span class="p">)),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span> <span class="o">==</span> <span class="s1">&#39;plausibility&#39;</span><span class="p">:</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">overall_plausibility</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span> <span class="o">==</span> <span class="s1">&#39;number_of_starting_materials&#39;</span><span class="p">:</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">number_of_starting_materials</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span> <span class="o">==</span> <span class="s1">&#39;number_of_reactions&#39;</span><span class="p">:</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">number_of_reactions</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need something to sort by! Invalid option provided </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span><span class="p">(),</span> <span class="n">trees</span></div>


    <span class="c1"># TODO: use these settings...</span>
<div class="viewcode-block" id="MCTS.get_buyable_paths"><a class="viewcode-back" href="../../../../makeit.retrosynthetic.mcts.html#makeit.retrosynthetic.mcts.tree_builder.MCTS.get_buyable_paths">[docs]</a>    <span class="k">def</span> <span class="nf">get_buyable_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">smiles</span><span class="p">,</span>
                          <span class="n">max_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                          <span class="n">max_branching</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                          <span class="n">expansion_time</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                          <span class="n">nproc</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                          <span class="n">num_active_pathways</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">chiral</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">max_trees</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                          <span class="n">max_ppg</span><span class="o">=</span><span class="mf">1e10</span><span class="p">,</span>
                          <span class="n">known_bad_reactions</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">forbidden_molecules</span><span class="o">=</span><span class="p">[],</span>
                          <span class="n">template_count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">max_cum_template_prob</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span>
                          <span class="n">max_natom_dict</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mf">1e9</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;logic&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}),</span>
                          <span class="n">min_chemical_history_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;as_reactant&#39;</span><span class="p">:</span><span class="mf">1e9</span><span class="p">,</span> <span class="s1">&#39;as_product&#39;</span><span class="p">:</span><span class="mf">1e9</span><span class="p">,</span><span class="s1">&#39;logic&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                          <span class="n">apply_fast_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">filter_threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                          <span class="n">soft_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">return_first</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">sort_trees_by</span><span class="o">=</span><span class="s1">&#39;plausibility&#39;</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns trees with path ending in buyable chemicals.</span>

<span class="sd">        Args:</span>
<span class="sd">            smiles (str): SMILES string of target molecule.</span>
<span class="sd">            max_depth (int, optional): Maximum number of reactions to allow</span>
<span class="sd">                before stopping the recursive expansion down one branch.</span>
<span class="sd">                (default: {10})</span>
<span class="sd">            max_branching (int, optional): Maximum number of precursor</span>
<span class="sd">                suggestions to add to the tree at each expansion.</span>
<span class="sd">                (default: {25})</span>
<span class="sd">            expansion_time (int, optional): Time (in seconds) to allow for</span>
<span class="sd">                expansion before searching the generated tree for buyable</span>
<span class="sd">                pathways. (default: {30})</span>
<span class="sd">            nproc (int, optional): Number of retrotransformer processes to fork</span>
<span class="sd">                for faster expansion. (default: {12})</span>
<span class="sd">            num_active_pathways (int or None, optional): Number of active</span>
<span class="sd">                pathways. (default: {None})</span>
<span class="sd">            chiral (bool, optional): Whether or not to pay close attention to</span>
<span class="sd">                chirality. When False, even achiral templates can lead to</span>
<span class="sd">                accidental inversion of chirality in non-reacting parts of the</span>
<span class="sd">                molecule. It is highly recommended to keep this as True.</span>
<span class="sd">                (default: {True})</span>
<span class="sd">            max_trees (int, optional): Maximum number of trees to return.</span>
<span class="sd">                (default: {5000})</span>
<span class="sd">            max_ppg (int, optional): Maximum price per gram of any chemical</span>
<span class="sd">                in a valid path. (default: {1e10})</span>
<span class="sd">            known_bad_reactions (list of str, optional): Reactions to eliminate</span>
<span class="sd">                from output. (default: {[]})</span>
<span class="sd">            forbidden_molecules (list of str, optional): SMILES strings of</span>
<span class="sd">                molecules to eliminate from output. (default: {[]})</span>
<span class="sd">            template_count (int, optional): Maximum number of relevant templates</span>
<span class="sd">                to consider. (default: {100})</span>
<span class="sd">            max_cum_template_prob (float, optional): Maximum cumulative</span>
<span class="sd">                probability of selected relevant templates. (default: {0.995})</span>
<span class="sd">            max_natom_dict (defaultdict, optional): Specifies maximum amounts</span>
<span class="sd">                for certain atoms and the logic it should use to select a</span>
<span class="sd">                chemical (buyable, buyable or max atoms, buyable and max atoms).</span>
<span class="sd">                (default: {defaultdict(lambda: 1e9, {&#39;logic&#39;: None})})</span>
<span class="sd">            min_chemical_history_dict (dict, optional): Minimum number of times</span>
<span class="sd">                a chemical must appear as a reactant or product to be selected</span>
<span class="sd">                when logic is &quot;OR&quot; and chemical is not buyable.</span>
<span class="sd">                (default: {{&#39;as_reactant&#39;:1e9, &#39;as_product&#39;:1e9,&#39;logic&#39;:None}})</span>
<span class="sd">            apply_fast_filter (bool, optional): Whether to apply the fast</span>
<span class="sd">                filter. (default: {True})</span>
<span class="sd">            filter_threshold (float, optional): Threshold to use for the fast</span>
<span class="sd">                filter. (default: {0.75})</span>
<span class="sd">            soft_reset (bool, optional): Whether to softly reset workers.</span>
<span class="sd">                (default: {False})</span>
<span class="sd">            return_first (bool, optional): Whether to return after finding first</span>
<span class="sd">                pathway. (default: {False})</span>
<span class="sd">            sort_trees_by (str, optional): Criteria used to sort trees.</span>
<span class="sd">                (default: {&#39;plausibility&#39;})</span>
<span class="sd">            **kwargs: Additional optional arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="n">max_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansion_time</span> <span class="o">=</span> <span class="n">expansion_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="k">if</span> <span class="n">num_active_pathways</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_active_pathways</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_active_pathways</span> <span class="o">=</span> <span class="n">num_active_pathways</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_trees</span> <span class="o">=</span> <span class="n">max_trees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cum_template_prob</span> <span class="o">=</span> <span class="n">max_cum_template_prob</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_count</span> <span class="o">=</span> <span class="n">template_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_threshold</span> <span class="o">=</span> <span class="n">filter_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_fast_filter</span> <span class="o">=</span> <span class="n">apply_fast_filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_chemical_history_dict</span> <span class="o">=</span> <span class="n">min_chemical_history_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_natom_dict</span> <span class="o">=</span> <span class="n">max_natom_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_ppg</span> <span class="o">=</span> <span class="n">max_ppg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort_trees_by</span> <span class="o">=</span> <span class="n">sort_trees_by</span>


        <span class="k">if</span> <span class="n">min_chemical_history_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">makeit.utilities.historian.chemicals</span> <span class="k">import</span> <span class="n">ChemHistorian</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span> <span class="o">=</span> <span class="n">ChemHistorian</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chemhistorian</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">refs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Loaded compressed chemhistorian from file&#39;</span><span class="p">,</span> <span class="n">treebuilder_loc</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Define stop criterion</span>
        <span class="k">def</span> <span class="nf">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ppg</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ppg</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_ppg</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">is_small_enough</span><span class="p">(</span><span class="n">smiles</span><span class="p">):</span>
            <span class="c1"># Get structural properties</span>
            <span class="n">natom_dict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mol</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">():</span>
                <span class="n">natom_dict</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">GetSymbol</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">natom_dict</span><span class="p">[</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">GetTotalNumHs</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mol</span><span class="o">.</span><span class="n">GetAtoms</span><span class="p">())</span>
            <span class="n">max_natom_satisfied</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">natom_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">v</span> <span class="k">for</span> <span class="p">(</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">max_natom_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;logic&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">max_natom_satisfied</span>
        <span class="k">def</span> <span class="nf">is_popular_enough</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_reactant&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_chemical_history_dict</span><span class="p">[</span><span class="s1">&#39;as_reactant&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                    <span class="n">hist</span><span class="p">[</span><span class="s1">&#39;as_product&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_chemical_history_dict</span><span class="p">[</span><span class="s1">&#39;as_product&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">min_chemical_history_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">max_natom_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">max_natom_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_small_enough</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_small_enough</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_natom_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_popular_enough</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">max_natom_dict</span><span class="p">[</span><span class="s1">&#39;logic&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_popular_enough</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_small_enough</span><span class="p">(</span><span class="n">smiles</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">is_a_terminal_node</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span> <span class="n">ppg</span><span class="p">,</span> <span class="n">hist</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">is_popular_enough</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">is_buyable</span><span class="p">(</span><span class="n">ppg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_small_enough</span><span class="p">(</span><span class="n">smiles</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_a_terminal_node</span> <span class="o">=</span> <span class="n">is_a_terminal_node</span>







        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">soft_reset</span><span class="o">=</span><span class="n">soft_reset</span><span class="p">)</span>

        <span class="n">MyLogger</span><span class="o">.</span><span class="n">print_and_log</span><span class="p">(</span><span class="s1">&#39;Starting search for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="n">treebuilder_loc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_tree</span><span class="p">(</span><span class="n">soft_stop</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;soft_stop&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">known_bad_reactions</span><span class="o">=</span><span class="n">known_bad_reactions</span><span class="p">,</span>
            <span class="n">forbidden_molecules</span><span class="o">=</span><span class="n">forbidden_molecules</span><span class="p">,</span>
            <span class="n">return_first</span><span class="o">=</span><span class="n">return_first</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_trees</span><span class="p">()</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--simulation_time&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--celery&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">MyLogger</span><span class="o">.</span><span class="n">initialize_logFile</span><span class="p">()</span>
    <span class="n">simulation_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">)</span>
    <span class="n">celery</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">celery</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Use celery? </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">celery</span><span class="p">))</span>

    <span class="c1"># Load tree builder</span>
    <span class="n">NCPUS</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> processes available ... &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">NCPUS</span><span class="p">))</span>
    <span class="n">Tree</span> <span class="o">=</span> <span class="n">MCTS</span><span class="p">(</span><span class="n">nproc</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span> <span class="n">mincount</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">RETRO_TRANSFORMS_CHIRAL</span><span class="p">[</span><span class="s1">&#39;mincount&#39;</span><span class="p">],</span>
        <span class="n">mincount_chiral</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">RETRO_TRANSFORMS_CHIRAL</span><span class="p">[</span><span class="s1">&#39;mincount_chiral&#39;</span><span class="p">],</span>
        <span class="n">celery</span><span class="o">=</span><span class="n">celery</span><span class="p">)</span>

    <span class="c1">####################################################################################</span>
    <span class="c1">############################# SCOPOLAMINE TEST #####################################</span>
    <span class="c1">####################################################################################</span>

    <span class="n">smiles</span> <span class="o">=</span> <span class="s1">&#39;Cc1ncc([N+](=O)[O-])n1CC(C)O&#39;</span>
    <span class="kn">import</span> <span class="nn">rdkit.Chem</span> <span class="k">as</span> <span class="nn">Chem</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">get_buyable_paths</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span>
                                        <span class="n">nproc</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span>
                                        <span class="n">expansion_time</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                                        <span class="n">max_cum_template_prob</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span>
                                        <span class="n">template_count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                        <span class="c1"># min_chemical_history_dict={&#39;as_reactant&#39;:5, &#39;as_product&#39;:5,&#39;logic&#39;:&#39;none&#39;},</span>
                                        <span class="n">soft_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">soft_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total num paths: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">####################################################################################</span>
    <span class="c1">############################# DEBUGGING ############################################</span>
    <span class="c1">####################################################################################</span>

    <span class="n">smiles</span> <span class="o">=</span> <span class="s1">&#39;CCCCCN(CCCCC)CCCC(=O)OCCC&#39;</span>
    <span class="kn">import</span> <span class="nn">rdkit.Chem</span> <span class="k">as</span> <span class="nn">Chem</span>
    <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">,</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">get_buyable_paths</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span>
                                        <span class="n">nproc</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span>
                                        <span class="n">expansion_time</span><span class="o">=</span><span class="n">simulation_time</span><span class="p">,</span>
                                        <span class="n">max_cum_template_prob</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span>
                                        <span class="n">template_count</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                                        <span class="n">soft_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">soft_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total num paths: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)))</span>
    <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1">####################################################################################</span>
    <span class="c1">############################# TESTING ##############################################</span>
    <span class="c1">####################################################################################</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;test_smiles.txt&#39;</span><span class="p">))</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">smiles_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

    <span class="c1"># ########### STAGE 1 - PROCESS ALL CHEMICALS</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;chemicals.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">[:</span><span class="n">N</span><span class="p">]):</span>
            <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">status</span><span class="p">,</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">Tree</span><span class="o">.</span><span class="n">get_buyable_paths</span><span class="p">(</span><span class="n">smiles</span><span class="p">,</span>
                                                <span class="n">nproc</span><span class="o">=</span><span class="n">NCPUS</span><span class="p">,</span>
                                                <span class="n">expansion_time</span><span class="o">=</span><span class="n">simulation_time</span><span class="p">,</span>
                                                <span class="n">soft_reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">soft_stop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">Tree</span><span class="o">.</span><span class="n">Chemicals</span><span class="p">,</span> <span class="n">Tree</span><span class="o">.</span><span class="n">time_for_first_path</span><span class="p">,</span> <span class="n">paths</span><span class="p">),</span> <span class="n">fid</span><span class="p">)</span>

    <span class="c1">########### STAGE 2 - ANALYZE RESULTS</span>
    <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_time</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pathway_count</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">min_price</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;chemicals.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">smiles</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">smiles_list</span><span class="p">[:</span><span class="n">N</span><span class="p">]):</span>
            <span class="n">smiles</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolToSmiles</span><span class="p">(</span><span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">smiles</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">(</span><span class="n">Chemicals</span><span class="p">,</span> <span class="n">ftime</span><span class="p">,</span> <span class="n">paths</span><span class="p">)</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>

            <span class="n">total</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">Chemicals</span><span class="p">[</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">price</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">first_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ftime</span><span class="p">)</span>
                <span class="n">pathway_count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
                <span class="n">min_price</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Chemicals</span><span class="p">[</span><span class="n">smiles</span><span class="p">]</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After looking at chemical index </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_id</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Success ratio: </span><span class="si">%f</span><span class="s1"> (</span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="o">/</span><span class="n">total</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>  <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average time for first pathway: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">first_time</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average number of pathways:     </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pathway_count</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;average minimum price:          </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">min_price</span><span class="p">))</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ASKCOS</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../askcos.html">askcos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../makeit.html">makeit package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rdchiral.html">rdchiral package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, ASKCOS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>