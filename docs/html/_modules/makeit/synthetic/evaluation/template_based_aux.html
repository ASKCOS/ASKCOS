
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>makeit.synthetic.evaluation.template_based_aux &#8212; ASKCOS 0.3.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for makeit.synthetic.evaluation.template_based_aux</h1><div class="highlight"><pre>
<span></span><span class="c1"># Import relevant packages</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">h5py</span> <span class="c1"># needed for save_weights, fails otherwise</span>
<span class="kn">import</span> <span class="nn">theano</span>
<span class="kn">import</span> <span class="nn">theano.tensor</span> <span class="k">as</span> <span class="nn">T</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="k">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Model</span><span class="p">,</span> <span class="n">model_from_json</span>
<span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Activation</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">merge</span>
<span class="kn">from</span> <span class="nn">keras.layers.core</span> <span class="k">import</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Permute</span><span class="p">,</span> <span class="n">Reshape</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span> <span class="n">RepeatVector</span>
<span class="kn">from</span> <span class="nn">keras.layers.wrappers</span> <span class="k">import</span> <span class="n">TimeDistributed</span>
<span class="kn">from</span> <span class="nn">keras.optimizers</span> <span class="k">import</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">Adadelta</span>
<span class="kn">from</span> <span class="nn">keras.layers.convolutional</span> <span class="k">import</span> <span class="n">Convolution1D</span><span class="p">,</span> <span class="n">Convolution2D</span>
<span class="kn">from</span> <span class="nn">keras.regularizers</span> <span class="k">import</span> <span class="n">l2</span>
<span class="kn">from</span> <span class="nn">keras.utils.np_utils</span> <span class="k">import</span> <span class="n">to_categorical</span>
<span class="n">no_printing</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">keras.utils.visualize_util</span> <span class="k">import</span> <span class="n">plot</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">no_printing</span> <span class="o">=</span> <span class="kc">True</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.descriptors</span> <span class="k">import</span> <span class="n">edits_to_vectors</span><span class="p">,</span> <span class="n">oneHotVector</span> <span class="c1"># for testing</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.threadsafe</span> <span class="k">import</span> <span class="n">threadsafe_generator</span>
<span class="kn">import</span> <span class="nn">rdkit.Chem</span> <span class="k">as</span> <span class="nn">Chem</span>

<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="k">import</span> <span class="n">coo_matrix</span>
<span class="kn">import</span> <span class="nn">makeit.utilities.io.pickle</span> <span class="k">as</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>    <span class="c1"># for visualization</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">ss</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">makeit.utilities.io.logger</span> <span class="k">import</span> <span class="n">MyLogger</span>
<span class="n">forwardPredictionNetwork_loc</span> <span class="o">=</span> <span class="s1">&#39;forwardPredictionNetwork&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">This script builds, trains, tests, and saves a context-dependent reaction </span>
<span class="sd">scoring model that works with a pre-generated .h5 dataset. By using a data</span>
<span class="sd">generator instead of reading from multiple files, data is pre-loaded for </span>
<span class="sd">upcoming minibatches, so the overall training time is substantially reduced.</span>

<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="msle_of_true"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.msle_of_true">[docs]</a><span class="k">def</span> <span class="nf">msle_of_true</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Custom loss function that uses the mean squared log error in predicted</span>
<span class="sd">    yield, assuming that y_pred are unscaled predictions with the true </span>
<span class="sd">    outcome in the first index.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">K</span><span class="o">.</span><span class="n">epsilon</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">))</span> <span class="o">-</span> <span class="n">K</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">K</span><span class="o">.</span><span class="n">epsilon</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)))</span></div>

<div class="viewcode-block" id="mse_of_true"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.mse_of_true">[docs]</a><span class="k">def</span> <span class="nf">mse_of_true</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Custom loss function that uses the mean squared error in predicted</span>
<span class="sd">    yield, assuming that y_pred are unscaled predictions with the true </span>
<span class="sd">    outcome in the first index.&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_pred</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">)</span></div>

<div class="viewcode-block" id="build"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.build">[docs]</a><span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="n">F_atom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">F_bond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_h1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">N_h2</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">N_h3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inner_act</span> <span class="o">=</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span> <span class="n">l2v</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0003</span><span class="p">,</span> <span class="n">N_hf</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">context_weight</span> <span class="o">=</span> <span class="mf">150.0</span><span class="p">,</span> <span class="n">enhancement_weight</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adadelta</span><span class="p">(),</span> <span class="n">extra_outputs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">TARGET_YIELD</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">absolute_score</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Builds the feed forward model.</span>

<span class="sd">    N_e:  maximum number of edits of each type</span>
<span class="sd">    N_h1: number of hidden nodes in first layer</span>
<span class="sd">    N_h2: number of hidden nodes in second layer</span>
<span class="sd">    inner_act: activation function </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">h_lost</span>    <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">F_atom</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;H_lost&quot;</span><span class="p">)</span>
    <span class="n">h_gain</span>    <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">F_atom</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;H_gain&quot;</span><span class="p">)</span>
    <span class="n">bond_lost</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">F_bond</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;bond_lost&quot;</span><span class="p">)</span>
    <span class="n">bond_gain</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">F_bond</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;bond_gain&quot;</span><span class="p">)</span>
    <span class="n">reagents</span>  <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;reagent_FP&quot;</span><span class="p">)</span> <span class="c1"># TODO: remove hard-coded length</span>
    <span class="n">solvent</span>   <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;solvent_descriptors_c_e_s_a_b_v&quot;</span><span class="p">)</span>
    <span class="n">temp</span>      <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;temperature_C&quot;</span><span class="p">)</span>

    <span class="c1"># h_lost_r    = Reshape((h_lost.shape[0] * h_lost.shape[1], F_atom), name = &quot;flatten H_lost&quot;)(h_lost)</span>
    <span class="c1"># h_gain_r    = Reshape((h_gain.shape[1] * h_gain.shape[1], F_atom), name = &quot;flatten H_gain&quot;)(h_gain)</span>
    <span class="c1"># bond_lost_r = Reshape((bond_lost.shape[0] * bond_lost.shape[1], F_bond), name = &quot;flatten bond_lost&quot;)(bond_lost)</span>
    <span class="c1"># bond_gain_r = Reshape((bond_gain.shape[0] * bond_gain.shape[1], F_bond), name = &quot;flatten bond_gain&quot;)(bond_gain)</span>

    <span class="c1"># Combine along first three dimensions</span>
    <span class="n">dynamic_reshaper</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">ndim</span>  <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dynamic_reshaper_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>

    <span class="n">h_lost_r</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_reshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_reshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;flatten_H_lost&quot;</span><span class="p">)(</span><span class="n">h_lost</span><span class="p">)</span>
    <span class="n">h_gain_r</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_reshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_reshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;flatten_H_gain&quot;</span><span class="p">)(</span><span class="n">h_gain</span><span class="p">)</span>
    <span class="n">bond_lost_r</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_reshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_reshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;flatten_bond_lost&quot;</span><span class="p">)(</span><span class="n">bond_lost</span><span class="p">)</span>
    <span class="n">bond_gain_r</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_reshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_reshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;flatten_bond_gain&quot;</span><span class="p">)(</span><span class="n">bond_gain</span><span class="p">)</span>

    <span class="n">h_lost_h1</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h1</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_lost 1&quot;</span><span class="p">)(</span><span class="n">h_lost_r</span><span class="p">)</span>
    <span class="n">h_gain_h1</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h1</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_gain 1&quot;</span><span class="p">)(</span><span class="n">h_gain_r</span><span class="p">)</span>
    <span class="n">bond_lost_h1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h1</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_lost 1&quot;</span><span class="p">)(</span><span class="n">bond_lost_r</span><span class="p">)</span>
    <span class="n">bond_gain_h1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h1</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_gain 1&quot;</span><span class="p">)(</span><span class="n">bond_gain_r</span><span class="p">)</span>

    <span class="n">N_h</span> <span class="o">=</span> <span class="n">N_h1</span>

    <span class="k">if</span> <span class="n">N_h2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">h_lost_h2</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h2</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_lost 2&quot;</span><span class="p">)(</span><span class="n">h_lost_h1</span><span class="p">)</span>
        <span class="n">h_gain_h2</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h2</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_gain 2&quot;</span><span class="p">)(</span><span class="n">h_gain_h1</span><span class="p">)</span>
        <span class="n">bond_lost_h2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h2</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_lost 2&quot;</span><span class="p">)(</span><span class="n">bond_lost_h1</span><span class="p">)</span>
        <span class="n">bond_gain_h2</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h2</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_gain 2&quot;</span><span class="p">)(</span><span class="n">bond_gain_h1</span><span class="p">)</span>
        <span class="n">N_h</span> <span class="o">=</span> <span class="n">N_h2</span>

        <span class="k">if</span> <span class="n">N_h3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h_lost_h</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_lost 3&quot;</span><span class="p">)(</span><span class="n">h_lost_h2</span><span class="p">)</span>
            <span class="n">h_gain_h</span>    <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed H_gain 3&quot;</span><span class="p">)(</span><span class="n">h_gain_h2</span><span class="p">)</span>
            <span class="n">bond_lost_h</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_lost 3&quot;</span><span class="p">)(</span><span class="n">bond_lost_h2</span><span class="p">)</span>
            <span class="n">bond_gain_h</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_h3</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;embed bond_gain 3&quot;</span><span class="p">)(</span><span class="n">bond_gain_h2</span><span class="p">)</span>
            <span class="n">N_h</span>         <span class="o">=</span> <span class="n">N_h3</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">h_lost_h</span>    <span class="o">=</span> <span class="n">h_lost_h2</span>
            <span class="n">h_gain_h</span>    <span class="o">=</span> <span class="n">h_gain_h2</span>
            <span class="n">bond_lost_h</span> <span class="o">=</span> <span class="n">bond_lost_h2</span>
            <span class="n">bond_gain_h</span> <span class="o">=</span> <span class="n">bond_gain_h2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">h_lost_h</span>    <span class="o">=</span> <span class="n">h_lost_h1</span>
        <span class="n">h_gain_h</span>    <span class="o">=</span> <span class="n">h_gain_h1</span>
        <span class="n">bond_lost_h</span> <span class="o">=</span> <span class="n">bond_lost_h1</span>
        <span class="n">bond_gain_h</span> <span class="o">=</span> <span class="n">bond_gain_h1</span>

    <span class="c1"># Re-expand (using tricky Merge layer, where x[0] is actual data and x[1] is only used for shape)</span>
    <span class="n">dynamic_unreshaper</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">T</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ndim</span>  <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">dynamic_unreshaper_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">h_lost_r2</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_unreshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_unreshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;expand H_lost edits&quot;</span><span class="p">)([</span><span class="n">h_lost_h</span><span class="p">,</span> <span class="n">h_lost</span><span class="p">])</span>
    <span class="n">h_gain_r2</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_unreshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_unreshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;expand H_gain edits&quot;</span><span class="p">)([</span><span class="n">h_gain_h</span><span class="p">,</span> <span class="n">h_gain</span><span class="p">])</span>
    <span class="n">bond_lost_r2</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_unreshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_unreshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;expand bond_lost edits&quot;</span><span class="p">)([</span><span class="n">bond_lost_h</span><span class="p">,</span> <span class="n">bond_lost</span><span class="p">])</span>
    <span class="n">bond_gain_r2</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">dynamic_unreshaper</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">dynamic_unreshaper_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;expand bond_gain edits&quot;</span><span class="p">)([</span><span class="n">bond_gain_h</span><span class="p">,</span> <span class="n">bond_gain</span><span class="p">])</span>

    <span class="c1"># Add edits within a single candidate</span>
    <span class="n">sum_along_axis2</span>       <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">sum_along_axis2_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
    <span class="n">h_lost_sum</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">sum_along_axis2</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">sum_along_axis2_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sum H_lost&quot;</span><span class="p">)(</span><span class="n">h_lost_r2</span><span class="p">)</span>
    <span class="n">h_gain_sum</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">sum_along_axis2</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">sum_along_axis2_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sum H_gain&quot;</span><span class="p">)(</span><span class="n">h_gain_r2</span><span class="p">)</span>
    <span class="n">bond_lost_sum</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">sum_along_axis2</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">sum_along_axis2_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sum bond_lost&quot;</span><span class="p">)(</span><span class="n">bond_lost_r2</span><span class="p">)</span>
    <span class="n">bond_gain_sum</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">sum_along_axis2</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">sum_along_axis2_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sum bond_gain&quot;</span><span class="p">)(</span><span class="n">bond_gain_r2</span><span class="p">)</span>

    <span class="c1"># Sum across edits in their intermediate representation</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">net_sum</span> <span class="o">=</span> <span class="n">merge</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">h_lost_sum</span><span class="p">,</span> <span class="n">h_gain_sum</span><span class="p">,</span> <span class="n">bond_lost_sum</span><span class="p">,</span> <span class="n">bond_gain_sum</span><span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;concat across edits&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">net_sum</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">h_lost_sum</span><span class="p">,</span> <span class="n">h_gain_sum</span><span class="p">,</span> <span class="n">bond_lost_sum</span><span class="p">,</span> <span class="n">bond_gain_sum</span><span class="p">],</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;concat across edits&quot;</span><span class="p">)</span>

    <span class="n">feature_to_feature</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_hf</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">))</span>
    <span class="n">net_sum_h</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">feature_to_feature</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;reaction embedding post-sum&quot;</span><span class="p">)(</span><span class="n">net_sum</span><span class="p">)</span>

    <span class="c1"># Take reagents -&gt; intermediate representation -&gt; cosine similarity to enhance reaction</span>
    <span class="n">reagents_h</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">N_hf</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;reagent fingerprint to features&quot;</span><span class="p">)(</span><span class="n">reagents</span><span class="p">)</span>

    <span class="c1"># Trick to repeat reagents using merge layer (so N_c is implicit)</span>
    <span class="c1"># x[0] is the original vector and x[1] is just to get the number of candidates (shape)</span>
    <span class="n">context_repeater</span>     <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">context_repeater_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">reagents_h_rpt</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">context_repeater</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">context_repeater_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;broadcast reagent vector&quot;</span><span class="p">)([</span><span class="n">reagents_h</span><span class="p">,</span> <span class="n">h_lost</span><span class="p">])</span>
    <span class="n">solvent_rpt</span>    <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">context_repeater</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">context_repeater_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;broadcast solvent vector&quot;</span><span class="p">)([</span><span class="n">solvent</span><span class="p">,</span> <span class="n">h_lost</span><span class="p">])</span>
    <span class="n">temp_rpt</span>       <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="n">context_repeater</span><span class="p">,</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="n">context_repeater_shape</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;broadcast temperature&quot;</span><span class="p">)([</span><span class="n">temp</span><span class="p">,</span> <span class="n">h_lost</span><span class="p">])</span>

    <span class="c1"># Dot product between reagents and net_sum_h gives enhancement factor</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">enhancement_mul</span> <span class="o">=</span> <span class="n">merge</span><span class="o">.</span><span class="n">multiply</span><span class="p">([</span><span class="n">net_sum_h</span><span class="p">,</span> <span class="n">reagents_h_rpt</span><span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;multiply reaction with reagents [dot 1/2]&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">enhancement_mul</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">net_sum_h</span><span class="p">,</span> <span class="n">reagents_h_rpt</span><span class="p">],</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;multiply reaction with reagents [dot 1/2]&quot;</span><span class="p">)</span>
    <span class="n">enhancement_r</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="n">output_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sum reaction with reagents [dot 2/2]&quot;</span><span class="p">)(</span><span class="n">enhancement_mul</span><span class="p">)</span>

    <span class="c1"># Converge to G0, C[not real], E, S, A, B, V, and K</span>
    <span class="n">feature_to_params</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">W_regularizer</span> <span class="o">=</span> <span class="n">l2</span><span class="p">(</span><span class="n">l2v</span><span class="p">))</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">TimeDistributed</span><span class="p">(</span><span class="n">feature_to_params</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;features to K,G0,C,E,S,A,B,V&quot;</span><span class="p">)(</span><span class="n">net_sum_h</span><span class="p">)</span>

    <span class="c1"># Concatenate enhancement and solvents</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">params_enhancement</span> <span class="o">=</span> <span class="n">merge</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">params</span><span class="p">,</span> <span class="n">enhancement_r</span><span class="p">,</span> <span class="n">solvent_rpt</span><span class="p">,</span> <span class="n">temp_rpt</span><span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;concatenate context&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">params_enhancement</span> <span class="o">=</span> <span class="n">merge</span><span class="p">([</span><span class="n">params</span><span class="p">,</span> <span class="n">enhancement_r</span><span class="p">,</span> <span class="n">solvent_rpt</span><span class="p">,</span> <span class="n">temp_rpt</span><span class="p">],</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;concatenate context&quot;</span><span class="p">)</span>
    
    <span class="c1"># # Calculate using thermo-ish</span>
    <span class="c1"># # K * exp(- (G0 + delG_solv) / T + enhancement)</span>
    <span class="c1"># unscaled_score = Lambda(</span>
    <span class="c1">#     lambda x: x[:, :, 0] * K.exp(- (x[:, :, 1] + K.sum(x[:, :, 2:8] * x[:, :, 8:14], axis = -1)) / (x[:, :, 15] + 273.15) + x[:, :, 8]),</span>
    <span class="c1">#     output_shape = lambda x: (None, N_c,),</span>
    <span class="c1">#     name = &quot;propensity = K * exp(- (G0 + cC + eE + ... + vV) / T + enh.)&quot;</span>
    <span class="c1"># )(params_enhancement)</span>

    <span class="n">unscaled_score</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">context_weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">9</span><span class="p">:</span><span class="mi">15</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">+</span> <span class="n">enhancement_weight</span> <span class="o">*</span> <span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">8</span><span class="p">],</span>
            <span class="n">output_shape</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;propensity = logK - (G0 + cC + eE + ... + vV) / T + enh.&quot;</span>
        <span class="p">)(</span><span class="n">params_enhancement</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">absolute_score</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">unscaled_score</span> 
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">TARGET_YIELD</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;softmax&#39;</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;scores to probs&quot;</span><span class="p">)(</span><span class="n">unscaled_score</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaled_score</span> <span class="o">=</span> <span class="n">Activation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">K</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mf">3.0</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;exponential activation&#39;</span><span class="p">)(</span><span class="n">unscaled_score</span><span class="p">)</span>
        <span class="c1"># Do not scale score with softmax (which would force 100% conversion)</span>
        <span class="c1"># Scale linearly</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">Lambda</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">K</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;scale if sum(score)&gt;1&quot;</span><span class="p">)(</span><span class="n">scaled_score</span><span class="p">)</span>


    <span class="c1">#score = unscaled_score_r</span>

    <span class="k">if</span> <span class="n">extra_outputs</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_lost</span><span class="p">,</span> <span class="n">h_gain</span><span class="p">,</span> <span class="n">bond_lost</span><span class="p">,</span> <span class="n">bond_gain</span><span class="p">,</span> <span class="n">reagents</span><span class="p">,</span> <span class="n">solvent</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span> 
            <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_lost_sum</span><span class="p">,</span> <span class="n">h_gain_sum</span><span class="p">,</span> <span class="n">bond_lost_sum</span><span class="p">,</span> <span class="n">bond_gain_sum</span><span class="p">,</span> <span class="n">net_sum</span><span class="p">,</span> <span class="n">net_sum_h</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">unscaled_score</span><span class="p">,</span> <span class="n">score</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span> <span class="o">=</span> <span class="p">[</span><span class="n">h_lost</span><span class="p">,</span> <span class="n">h_gain</span><span class="p">,</span> <span class="n">bond_lost</span><span class="p">,</span> <span class="n">bond_gain</span><span class="p">,</span> <span class="n">reagents</span><span class="p">,</span> <span class="n">solvent</span><span class="p">,</span> <span class="n">temp</span><span class="p">],</span> 
        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">])</span>

    <span class="c1"># model.summary()</span>

    <span class="c1"># Now compile</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">TARGET_YIELD</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">,</span> 
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">mse_of_true</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span></div>

<span class="nd">@threadsafe_generator</span>
<span class="k">def</span> <span class="nf">data_generator</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">max_N_c</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This function generates batches of data from the</span>
<span class="sd">    pickle file since all the data can&#39;t fit in memory.</span>

<span class="sd">    The starting and ending indices are specified explicitly so the</span>
<span class="sd">    same function can be used for validation data as well</span>

<span class="sd">    Input tensors are generated on-the-fly so there is less I/O</span>

<span class="sd">    max_N_c is the maximum number of candidates to consider. This should ONLY be used</span>
<span class="sd">    for training, not for validation or testing.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">bond_string_to_tuple</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">fileInfo</span>  <span class="o">=</span> <span class="p">[()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)]</span> <span class="c1"># (filePos, startIndex, endIndex)</span>
    <span class="n">batchDims</span> <span class="o">=</span> <span class="p">[()</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)]</span> <span class="c1"># dimensions of each batch</span>
    <span class="n">batchNums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">))])</span> <span class="c1"># list to shuffle later</span>

    <span class="c1"># Keep returning forever and ever</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATA_FPATH</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>

        <span class="c1"># Do a first pass through the data</span>
        <span class="n">legend_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># first doc is legend</span>

        <span class="c1"># Pre-load indeces</span>
        <span class="n">CANDIDATE_EDITS_COMPACT</span> <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;candidate_edits_compact&#39;</span><span class="p">]</span>
        <span class="n">ATOM_DESC_DICT</span>          <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;atom_desc_dict&#39;</span><span class="p">]</span>
        <span class="n">T</span>                       <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">SOLVENT</span>                 <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;solvent&#39;</span><span class="p">]</span>
        <span class="n">REAGENT</span>                 <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;reagent&#39;</span><span class="p">]</span>
        <span class="n">YIELD</span>                   <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;yield&#39;</span><span class="p">]</span>
        <span class="n">REACTION_TRUE_ONEHOT</span>    <span class="o">=</span> <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;reaction_true_onehot&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">):</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># throw away first ___ entries</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">startIndex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)):</span>
            <span class="n">endIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startIndex</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">end_at</span><span class="p">)</span>

            <span class="c1"># Remember this starting position</span>
            <span class="n">fileInfo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fid</span><span class="o">.</span><span class="n">tell</span><span class="p">(),</span> <span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)</span>

            <span class="n">N</span> <span class="o">=</span> <span class="n">endIndex</span> <span class="o">-</span> <span class="n">startIndex</span> <span class="c1"># number of samples this batch</span>
            <span class="c1"># print(&#39;Serving up examples {} through {}&#39;.format(startIndex, endIndex))</span>

            <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)]</span>

            <span class="c1"># FNeed to figure out size of padded batch</span>
            <span class="n">N_c</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE_ONEHOT</span><span class="p">])</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_N_c</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> <span class="c1"># allow truncation during training</span>
                <span class="n">N_c</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">N_c</span><span class="p">,</span> <span class="n">max_N_c</span><span class="p">)</span>
            <span class="n">N_e1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">N_e2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">N_e3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">N_e4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">edit_string</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="n">CANDIDATE_EDITS_COMPACT</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">N_c</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">edit_string_split</span> <span class="o">=</span> <span class="n">edit_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                    <span class="n">N_e1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">N_e1</span><span class="p">,</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">N_e2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">N_e2</span><span class="p">,</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">N_e3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">N_e3</span><span class="p">,</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">N_e4</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">N_e4</span><span class="p">,</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Remember sizes of x_h_lost, x_h_gain, x_bond_lost, x_bond_gain, reaction_true_onehot</span>
            <span class="n">batchDim</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e1</span><span class="p">,</span> <span class="n">N_e2</span><span class="p">,</span> <span class="n">N_e3</span><span class="p">,</span> <span class="n">N_e4</span><span class="p">)</span>

            <span class="c1"># print(&#39;The padded sizes of this batch will be: N, N_c, N_e1, N_e2, N_e3, N_e4&#39;)</span>
            <span class="c1"># print(batchDim)</span>
            <span class="n">batchDims</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchDim</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">batchNums</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">batchNum</span> <span class="ow">in</span> <span class="n">batchNums</span><span class="p">:</span>
                <span class="p">(</span><span class="n">filePos</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)</span> <span class="o">=</span> <span class="n">fileInfo</span><span class="p">[</span><span class="n">batchNum</span><span class="p">]</span>
                <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e1</span><span class="p">,</span> <span class="n">N_e2</span><span class="p">,</span> <span class="n">N_e3</span><span class="p">,</span> <span class="n">N_e4</span><span class="p">)</span> <span class="o">=</span> <span class="n">batchDims</span><span class="p">[</span><span class="n">batchNum</span><span class="p">]</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">filePos</span><span class="p">)</span>

                <span class="n">N</span> <span class="o">=</span> <span class="n">endIndex</span> <span class="o">-</span> <span class="n">startIndex</span> <span class="c1"># number of samples this batch</span>
                <span class="c1"># print(&#39;Serving up examples {} through {}&#39;.format(startIndex, endIndex))</span>

                <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)]</span>

                <span class="c1"># Initialize numpy arrays for x_h_lost, etc.</span>
                <span class="n">x_h_lost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e1</span><span class="p">,</span> <span class="n">F_atom</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">x_h_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e2</span><span class="p">,</span> <span class="n">F_atom</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">x_bond_lost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e3</span><span class="p">,</span> <span class="n">F_bond</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">x_bond_gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">,</span> <span class="n">N_e4</span><span class="p">,</span> <span class="n">F_bond</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">reaction_true_onehot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">N_c</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">yields</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>

                    <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">edit_string</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="n">CANDIDATE_EDITS_COMPACT</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">N_c</span><span class="p">:</span> 
                            <span class="k">break</span>
                        
                        <span class="n">edit_string_split</span> <span class="o">=</span> <span class="n">edit_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                        <span class="n">edits</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">[</span><span class="n">atom_string</span> <span class="k">for</span> <span class="n">atom_string</span> <span class="ow">in</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">atom_string</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">atom_string</span> <span class="k">for</span> <span class="n">atom_string</span> <span class="ow">in</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">atom_string</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">bond_string_to_tuple</span><span class="p">(</span><span class="n">bond_string</span><span class="p">)</span> <span class="k">for</span> <span class="n">bond_string</span> <span class="ow">in</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">bond_string</span><span class="p">],</span>
                            <span class="p">[</span><span class="n">bond_string_to_tuple</span><span class="p">(</span><span class="n">bond_string</span><span class="p">)</span> <span class="k">for</span> <span class="n">bond_string</span> <span class="ow">in</span> <span class="n">edit_string_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">bond_string</span><span class="p">],</span>
                        <span class="p">]</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">edit_h_lost_vec</span><span class="p">,</span> <span class="n">edit_h_gain_vec</span><span class="p">,</span> \
                                <span class="n">edit_bond_lost_vec</span><span class="p">,</span> <span class="n">edit_bond_gain_vec</span> <span class="o">=</span> <span class="n">edits_to_vectors</span><span class="p">(</span><span class="n">edits</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">atom_desc_dict</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">ATOM_DESC_DICT</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># sometimes molAtomMapNumber not found if hydrogens were explicit</span>
                            <span class="k">continue</span>

                        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">edit_h_lost</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edit_h_lost_vec</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">N_e1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;N_e1 not large enough!&#39;</span><span class="p">)</span>
                            <span class="n">x_h_lost</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">edit_h_lost</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">edit_h_gain</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edit_h_gain_vec</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">N_e2</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;N_e2 not large enough!&#39;</span><span class="p">)</span>
                            <span class="n">x_h_gain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">edit_h_gain</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">edit_bond_lost</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edit_bond_lost_vec</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">N_e3</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;N_e3 not large enough!&#39;</span><span class="p">)</span>
                            <span class="n">x_bond_lost</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">edit_bond_lost</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">edit_bond_gain</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">edit_bond_gain_vec</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="n">N_e4</span><span class="p">:</span> <span class="k">raise</span> <span class="n">ValueRrror</span><span class="p">(</span><span class="s1">&#39;N_e4 not large enough!&#39;</span><span class="p">)</span>
                            <span class="n">x_bond_gain</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">edit_bond_gain</span>

                    <span class="c1"># Add truncated reaction true (eventually will not truncate)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">max_N_c</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                        <span class="n">reaction_true_onehot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE_ONEHOT</span><span class="p">])]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE_ONEHOT</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reaction_true_onehot</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE_ONEHOT</span><span class="p">]),</span> <span class="n">max_N_c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE_ONEHOT</span><span class="p">][:</span><span class="n">max_N_c</span><span class="p">]</span>
                    <span class="n">yields</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">YIELD</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>

                <span class="c1"># Get rid of NaNs</span>
                <span class="n">x_h_lost</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_h_lost</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_h_gain</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_h_gain</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_bond_lost</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_bond_lost</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_bond_gain</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x_bond_gain</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_h_lost</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x_h_lost</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_h_gain</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x_h_gain</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_bond_lost</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x_bond_lost</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">x_bond_gain</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">x_bond_gain</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># print(&#39;Batch {} to {}&#39;.format(startIndex, endIndex))</span>
                <span class="c1"># yield (x, y) as tuple, but each one is a list</span>

                <span class="k">if</span> <span class="n">TARGET_YIELD</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">yields</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">reaction_true_onehot</span>

                <span class="k">yield</span> <span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">x_h_lost</span><span class="p">,</span>
                        <span class="n">x_h_gain</span><span class="p">,</span>
                        <span class="n">x_bond_lost</span><span class="p">,</span>
                        <span class="n">x_bond_gain</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="n">REAGENT</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="c1"># reagent</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="n">SOLVENT</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="c1"># solvent</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">doc</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="c1"># temperature</span>
                    <span class="p">],</span>
                    <span class="p">[</span>
                        <span class="n">y</span><span class="p">,</span>
                    <span class="p">],</span>
                <span class="p">)</span>

<span class="nd">@threadsafe_generator</span>
<span class="k">def</span> <span class="nf">label_generator</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This function generates labels to match the data generated</span>
<span class="sd">    by data_generator&#39;&#39;&#39;</span>

    <span class="n">filePos_start_at</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># Keep returning forever and ever</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LABELS_FPATH</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Is this the first iteration?</span>
            <span class="k">if</span> <span class="n">filePos_start_at</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                <span class="c1"># Remember where data starts</span>
                <span class="n">legend_labels</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># first doc is legend</span>
                <span class="n">CANDIDATE_SMILES</span> <span class="o">=</span> <span class="n">legend_labels</span><span class="p">[</span><span class="s1">&#39;candidate_smiles&#39;</span><span class="p">]</span>
                <span class="n">CANDIDATE_EDITS</span>  <span class="o">=</span> <span class="n">legend_labels</span><span class="p">[</span><span class="s1">&#39;candidate_edits_compact&#39;</span><span class="p">]</span>
                <span class="n">REACTION_TRUE</span>    <span class="o">=</span> <span class="n">legend_labels</span><span class="p">[</span><span class="s1">&#39;reaction_true&#39;</span><span class="p">]</span>
                <span class="n">RXDID</span>            <span class="o">=</span> <span class="n">legend_labels</span><span class="p">[</span><span class="s1">&#39;rxdid&#39;</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">):</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="c1"># throw away first ___ entries</span>
                <span class="n">filePos_start_at</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">filePos_start_at</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">startIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_at</span><span class="p">,</span> <span class="n">end_at</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
                <span class="n">endIndex</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startIndex</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">end_at</span><span class="p">)</span>

                <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)]</span>
                <span class="k">yield</span> <span class="p">{</span>
                    <span class="s1">&#39;candidate_smiles&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">CANDIDATE_SMILES</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span>
                    <span class="s1">&#39;candidate_edits&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">CANDIDATE_EDITS</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span>
                    <span class="s1">&#39;reaction_true&#39;</span><span class="p">:</span>    <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">REACTION_TRUE</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">],</span>
                    <span class="s1">&#39;rxdid&#39;</span><span class="p">:</span>            <span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="n">RXDID</span><span class="p">]</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="n">filePos_start_at</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<div class="viewcode-block" id="get_data"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.get_data">[docs]</a><span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="n">max_N_c</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creates a dictionary defining data generators for </span>
<span class="sd">    training and validation given pickled data/label files</span>

<span class="sd">    max_N_c and shuffle only refers to training data&#39;&#39;&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DATA_FPATH</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">legend_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">LABELS_FPATH</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="n">legend_labels</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>

    <span class="n">N_samples</span> <span class="o">=</span>  <span class="n">legend_data</span><span class="p">[</span><span class="s1">&#39;N_examples&#39;</span><span class="p">]</span>
    <span class="n">N_train</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_samples</span> <span class="o">*</span> <span class="n">split_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">N_val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_samples</span> <span class="o">*</span> <span class="n">split_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">N_test</span> <span class="o">=</span> <span class="n">N_samples</span> <span class="o">-</span> <span class="n">N_train</span> <span class="o">-</span> <span class="n">N_val</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of samples: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N_samples</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training   on </span><span class="si">{}</span><span class="s1">% - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">N_train</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Validating on </span><span class="si">{}</span><span class="s1">% - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">N_val</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing    on </span><span class="si">{}</span><span class="s1">% - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">split_ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">split_ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">N_test</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;N_samples&#39;</span><span class="p">:</span> <span class="n">N_samples</span><span class="p">,</span>
        <span class="s1">&#39;N_train&#39;</span><span class="p">:</span> <span class="n">N_train</span><span class="p">,</span>
        <span class="c1">#</span>
        <span class="s1">&#39;train_generator&#39;</span><span class="p">:</span> <span class="n">data_generator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">max_N_c</span> <span class="o">=</span> <span class="n">max_N_c</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span><span class="p">),</span>
        <span class="s1">&#39;train_label_generator&#39;</span><span class="p">:</span> <span class="n">label_generator</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_train</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="s1">&#39;train_nb_samples&#39;</span><span class="p">:</span> <span class="n">N_train</span><span class="p">,</span>
        <span class="c1">#</span>
        <span class="s1">&#39;val_generator&#39;</span><span class="p">:</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">N_train</span><span class="p">,</span> <span class="n">N_train</span> <span class="o">+</span> <span class="n">N_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="s1">&#39;val_label_generator&#39;</span><span class="p">:</span> <span class="n">label_generator</span><span class="p">(</span><span class="n">N_train</span><span class="p">,</span> <span class="n">N_train</span> <span class="o">+</span> <span class="n">N_val</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="s1">&#39;val_nb_samples&#39;</span><span class="p">:</span> <span class="n">N_val</span><span class="p">,</span>
        <span class="c1">#</span>
        <span class="s1">&#39;test_generator&#39;</span><span class="p">:</span> <span class="n">data_generator</span><span class="p">(</span><span class="n">N_train</span> <span class="o">+</span> <span class="n">N_val</span><span class="p">,</span> <span class="n">N_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="s1">&#39;test_label_generator&#39;</span><span class="p">:</span> <span class="n">label_generator</span><span class="p">(</span><span class="n">N_train</span> <span class="o">+</span> <span class="n">N_val</span><span class="p">,</span> <span class="n">N_samples</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">),</span>
        <span class="s1">&#39;test_nb_samples&#39;</span><span class="p">:</span> <span class="n">N_test</span><span class="p">,</span>
        <span class="c1">#</span>
        <span class="c1">#</span>
        <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="n">batch_size</span><span class="p">,</span>
    <span class="p">}</span></div>

<div class="viewcode-block" id="train"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.train">[docs]</a><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Trains the Keras model&#39;&#39;&#39;</span>

    <span class="c1"># Add additional callbacks</span>
    <span class="kn">from</span> <span class="nn">keras.callbacks</span> <span class="k">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">CSVLogger</span><span class="p">,</span> <span class="n">EarlyStopping</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">WEIGHTS_FPATH</span><span class="p">,</span> <span class="n">save_weights_only</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span> <span class="c1"># save every epoch</span>
        <span class="n">CSVLogger</span><span class="p">(</span><span class="n">HIST_FPATH</span><span class="p">),</span>
        <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span> <span class="o">=</span> <span class="mi">5</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;train_generator&#39;</span><span class="p">],</span> 
            <span class="n">samples_per_epoch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;train_nb_samples&#39;</span><span class="p">],</span>
            <span class="n">nb_epoch</span> <span class="o">=</span> <span class="n">nb_epoch</span><span class="p">,</span> 
            <span class="n">validation_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;val_generator&#39;</span><span class="p">],</span>
            <span class="n">nb_val_samples</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;val_nb_samples&#39;</span><span class="p">],</span>
            <span class="c1">#pickle_safe = True,</span>
            <span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span><span class="p">,</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stopped training early!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../../../makeit.synthetic.evaluation.html#makeit.synthetic.evaluation.template_based_aux.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Given a trained model and a list of samples, this function tests</span>
<span class="sd">    the model</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing model&#39;</span><span class="p">)</span>

    <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TEST_FPATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s1">&#39;reaction_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;train/val&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;true_edit&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_true_edit&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;predicted_edit(or no. 2)&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_predicted_edit(or no. 2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rank_true_edit&#39;</span><span class="p">,</span> <span class="s1">&#39;true_smiles&#39;</span><span class="p">,</span> <span class="s1">&#39;predicted_smiles(or no. 2)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;RXD_id&#39;</span><span class="p">,</span><span class="s1">&#39;yield_true&#39;</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_on_set</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">data_generator</span><span class="p">,</span> <span class="n">label_generator</span><span class="p">,</span> <span class="n">num_batches</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper function that works for both training and validation sets&#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Testing on </span><span class="si">{}</span><span class="s1"> data&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="p">))</span>
        <span class="c1"># Need to process data using generator</span>

        <span class="n">our_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">true_preds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">batch_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_batches</span><span class="p">):</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">label_generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># only one output, which is True/False or yield</span>
        
            <span class="c1"># TODO: pre-fetch data in queue</span>
            <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_on_batch</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> 

                <span class="n">edits</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="s1">&#39;candidate_edits&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">TARGET_YIELD</span><span class="p">:</span>
                    <span class="n">trueprob</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># prob assigned to true outcome</span>
                    <span class="n">rank_true_edit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">pred</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:])]</span>
                    
                    <span class="n">true_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trueprob</span><span class="p">)</span>
                    <span class="n">our_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:])])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:]):</span>
                        <span class="n">corr</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Get most informative labels for the highest predictions</span>
                    <span class="k">if</span> <span class="n">rank_true_edit</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># record highest probability</span>
                        <span class="n">most_likely_edit_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                        <span class="n">most_likely_prob</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># record number two prediction</span>
                        <span class="n">most_likely_edit_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">pred</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">)])</span>
                        <span class="n">most_likely_prob</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="n">pred</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">)])</span>
                    <span class="n">trueyield</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="s1">&#39;reaction_true&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,y:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="mf">100.0</span>


                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trueprob</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># true outcome always at first index</span>
                    <span class="n">trueyield</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                    <span class="n">rank_true_edit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">pred</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">rank_true_edit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">corr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">true_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trueprob</span><span class="p">)</span>
                    <span class="n">our_preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rank_true_edit</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">most_likely_edit_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                        <span class="n">most_likely_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">most_likely_edit_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># without first one</span>
                        <span class="n">most_likely_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">most_likely_smiles</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="s1">&#39;candidate_smiles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">most_likely_edit_i</span><span class="p">]</span>
                    <span class="n">most_likely_edit</span>   <span class="o">=</span> <span class="n">edits</span><span class="p">[</span><span class="n">most_likely_edit_i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">most_likely_smiles</span> <span class="o">=</span> <span class="s1">&#39;no_reaction&#39;</span>
                    <span class="n">most_likely_edit</span>   <span class="o">=</span> <span class="s1">&#39;no_reaction&#39;</span>


                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">labels</span><span class="p">[</span><span class="s1">&#39;reaction_true&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">dataset</span><span class="p">,</span> 
                    <span class="n">edits</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,:])],</span> <span class="n">trueprob</span><span class="p">,</span> 
                    <span class="n">most_likely_edit</span><span class="p">,</span> <span class="n">most_likely_prob</span><span class="p">,</span>
                    <span class="n">rank_true_edit</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="s1">&#39;reaction_true&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                    <span class="n">most_likely_smiles</span><span class="p">,</span> <span class="n">labels</span><span class="p">[</span><span class="s1">&#39;rxdid&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">trueyield</span>
                <span class="p">))</span>

        <span class="k">return</span> <span class="n">our_preds</span><span class="p">,</span> <span class="n">corr</span>

    <span class="n">train_preds</span><span class="p">,</span> <span class="n">train_corr</span> <span class="o">=</span> <span class="n">test_on_set</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;train_generator&#39;</span><span class="p">],</span> 
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;train_label_generator&#39;</span><span class="p">],</span> 
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;train_nb_samples&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])))</span>
    <span class="p">)</span>
    <span class="n">val_preds</span><span class="p">,</span> <span class="n">val_corr</span> <span class="o">=</span> <span class="n">test_on_set</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;val_generator&#39;</span><span class="p">],</span> 
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;val_label_generator&#39;</span><span class="p">],</span> 
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;val_nb_samples&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])))</span>
    <span class="p">)</span>
    <span class="n">test_preds</span><span class="p">,</span> <span class="n">test_corr</span> <span class="o">=</span> <span class="n">test_on_set</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;test_generator&#39;</span><span class="p">],</span> 
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;test_label_generator&#39;</span><span class="p">],</span> 
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;test_nb_samples&#39;</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">])))</span>
    <span class="p">)</span>

    <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_corr</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_preds</span><span class="p">))</span>
    <span class="n">val_acc</span> <span class="o">=</span> <span class="n">val_corr</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val_preds</span><span class="p">))</span>
    <span class="n">test_acc</span> <span class="o">=</span> <span class="n">test_corr</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_preds</span><span class="p">))</span>

    <span class="n">train_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">train_preds</span><span class="p">)</span>
    <span class="n">val_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">val_preds</span><span class="p">)</span>
    <span class="n">test_preds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">test_preds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">histogram</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">acc</span><span class="p">):</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">acc</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">/</span><span class="mf">1000.</span> <span class="c1"># round3</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Visualize in histogram</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">array</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Assigned probability to true product&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized frequency&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histogram of pseudo-probabilities - </span><span class="si">{}</span><span class="s1"> (N=</span><span class="si">{}</span><span class="s1">,acc=</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="n">acc</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">bbox_inches</span> <span class="o">=</span> <span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">histogram</span><span class="p">(</span><span class="n">train_preds</span><span class="p">,</span> <span class="s1">&#39;TRAIN&#39;</span><span class="p">,</span> <span class="n">HISTOGRAM_FPATH</span> <span class="o">%</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">train_acc</span><span class="p">)</span>
    <span class="n">histogram</span><span class="p">(</span><span class="n">val_preds</span><span class="p">,</span> <span class="s1">&#39;VAL&#39;</span><span class="p">,</span> <span class="n">HISTOGRAM_FPATH</span> <span class="o">%</span> <span class="s1">&#39;val&#39;</span><span class="p">,</span> <span class="n">val_acc</span><span class="p">)</span>
    <span class="n">histogram</span><span class="p">(</span><span class="n">test_preds</span><span class="p">,</span> <span class="s1">&#39;TEST&#39;</span><span class="p">,</span> <span class="n">HISTOGRAM_FPATH</span> <span class="o">%</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">test_acc</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--nb_epoch&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of epochs to train for, default 100&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch_size&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Batch size, default 20&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nh1&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of hidden nodes in first layer, default 40&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nh2&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of hidden nodes in second layer, default 0&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nh3&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of hidden nodes in third layer, &#39;</span> <span class="o">+</span> 
                                <span class="s1">&#39;immediately before summing, default 0&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nhf&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of hidden nodes in layer between summing &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;and final score, default 20&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tag&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Tag for this model&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--retrain&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Retrain with loaded weights, default False&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--test&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Test model only, default False&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--l2&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;l2 regularization parameter for each Dense layer, default 0.01&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data_tag&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;makeit/predict/data_edits_reaxys/reaxys&#39;</span><span class="p">,</span>
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Data file tag, default makeit/predict/data_edits_reaxys/reaxys&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--lr&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> 
                        <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Learning rate, default 0.01&#39;</span><span class="p">)</span>
    <span class="c1"># parser.add_argument(&#39;--dr&#39;, type = float, default = 0.5,</span>
    <span class="c1">#                     help = &#39;Dropout rate, default 0.5&#39;)</span>
    <span class="c1"># parser.add_argument(&#39;--fold&#39;, type = int, default = 5, </span>
    <span class="c1">#                     help = &#39;Which fold of the 5-fold CV is this? Defaults 5&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--visualize&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Whether or not to visualize weights ONLY, default False&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--context_weight&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
                    <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Weight assigned to contextual effects, default 100.0&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--enhancement_weight&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">float</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Weight assigned to enhancement factor, default 0.1&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--Nc&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Number of candidates to truncate to during training, default 1000&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--optimizer&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Optimizer to use, default adadelta&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--inner_act&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;tanh&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Inner activation function, default &quot;tanh&quot; &#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--yd&#39;</span><span class="p">,</span> <span class="nb">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Are we targeting yield? 0 or 1, default 0&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    
    <span class="n">nb_epoch</span>           <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">nb_epoch</span><span class="p">)</span>
    <span class="n">batch_size</span>         <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="n">N_h1</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">Nh1</span><span class="p">)</span>
    <span class="n">N_h2</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">Nh2</span><span class="p">)</span>
    <span class="n">N_h3</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">Nh3</span><span class="p">)</span>
    <span class="n">N_hf</span>               <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">Nhf</span><span class="p">)</span>
    <span class="n">l2v</span>                <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span>
    <span class="n">lr</span>                 <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">max_N_c</span>            <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">Nc</span><span class="p">)</span> <span class="c1"># number of candidate edit sets</span>
    <span class="n">context_weight</span>     <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">context_weight</span><span class="p">)</span>
    <span class="n">enhancement_weight</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">enhancement_weight</span><span class="p">)</span>
    <span class="n">optimizer</span>          <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">optimizer</span>
    <span class="n">inner_act</span>          <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">inner_act</span>
    <span class="n">TARGET_YIELD</span>       <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">yd</span><span class="p">)</span>

    <span class="c1"># THIS_FOLD_OUT_OF_FIVE = int(args.fold)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tag</span>

    <span class="n">split_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># 80% training, 10% validation, balance testing</span>

    <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;sgd&#39;</span><span class="p">:</span>
        <span class="n">opt</span>  <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="n">decay</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;adam&#39;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s1">&#39;adadelta&#39;</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">Adadelta</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Because Adadelta was selected, ignoring lr setting&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unrecognized optimizer&#39;</span><span class="p">)</span>

    <span class="c1"># Labels</span>
    <span class="n">FROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s1">&#39;output&#39;</span><span class="p">)</span>
    <span class="n">FROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">FROOT</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">FROOT</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">FROOT</span><span class="p">)</span>
    <span class="n">MODEL_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;model.json&#39;</span><span class="p">)</span>
    <span class="n">WEIGHTS_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;weights.h5&#39;</span><span class="p">)</span>
    <span class="n">HIST_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;hist.csv&#39;</span><span class="p">)</span>
    <span class="n">TEST_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;probs.dat&#39;</span><span class="p">)</span>
    <span class="n">HISTOGRAM_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;histogram </span><span class="si">%s</span><span class="s1">.png&#39;</span><span class="p">)</span>
    <span class="n">ARGS_FPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;args.json&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ARGS_FPATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">json</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">fid</span><span class="p">)</span>

    <span class="n">DATA_FPATH</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_data.pickle&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tag</span><span class="p">)</span>
    <span class="n">LABELS_FPATH</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_labels.pickle&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">data_tag</span><span class="p">)</span>

    <span class="n">this_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="s1">&#39;[CH3:1][CH3:2]&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">edits_to_vectors</span><span class="p">(([</span><span class="s1">&#39;1&#39;</span><span class="p">],[],[(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)],[]),</span> <span class="n">mol</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">this_dir</span><span class="p">)</span>

    <span class="n">F_atom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">F_bond</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">retrain</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reloading from file&#39;</span><span class="p">)</span>
        <span class="n">rebuild</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;Do you want to rebuild from scratch instead of loading from file? [n/y] &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rebuild</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">F_atom</span> <span class="o">=</span> <span class="n">F_atom</span><span class="p">,</span> <span class="n">F_bond</span> <span class="o">=</span> <span class="n">F_bond</span><span class="p">,</span> <span class="n">N_h1</span> <span class="o">=</span> <span class="n">N_h1</span><span class="p">,</span> 
                <span class="n">N_h2</span> <span class="o">=</span> <span class="n">N_h2</span><span class="p">,</span> <span class="n">N_h3</span> <span class="o">=</span> <span class="n">N_h3</span><span class="p">,</span> <span class="n">N_hf</span> <span class="o">=</span> <span class="n">N_hf</span><span class="p">,</span> <span class="n">l2v</span> <span class="o">=</span> <span class="n">l2v</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">opt</span><span class="p">,</span> <span class="n">inner_act</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span>
                <span class="n">context_weight</span> <span class="o">=</span> <span class="n">context_weight</span><span class="p">,</span> <span class="n">enhancement_weight</span> <span class="o">=</span> <span class="n">enhancement_weight</span><span class="p">,</span> <span class="n">extra_outputs</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">visualize</span><span class="p">),</span>
                <span class="n">TARGET_YIELD</span> <span class="o">=</span> <span class="n">TARGET_YIELD</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">MODEL_FPATH</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">TARGET_YIELD</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="n">mse_of_true</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span> 
                <span class="n">optimizer</span> <span class="o">=</span> <span class="n">opt</span><span class="p">,</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">WEIGHTS_FPATH</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">build</span><span class="p">(</span><span class="n">F_atom</span> <span class="o">=</span> <span class="n">F_atom</span><span class="p">,</span> <span class="n">F_bond</span> <span class="o">=</span> <span class="n">F_bond</span><span class="p">,</span> <span class="n">N_h1</span> <span class="o">=</span> <span class="n">N_h1</span><span class="p">,</span> <span class="n">N_h2</span> <span class="o">=</span> <span class="n">N_h2</span><span class="p">,</span> <span class="n">N_h3</span> <span class="o">=</span> <span class="n">N_h3</span><span class="p">,</span> <span class="n">N_hf</span> <span class="o">=</span> <span class="n">N_hf</span><span class="p">,</span> <span class="n">l2v</span> <span class="o">=</span> <span class="n">l2v</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span><span class="p">,</span> <span class="n">context_weight</span> <span class="o">=</span> <span class="n">context_weight</span><span class="p">,</span> <span class="n">inner_act</span> <span class="o">=</span> <span class="n">inner_act</span><span class="p">,</span>
            <span class="n">enhancement_weight</span> <span class="o">=</span> <span class="n">enhancement_weight</span><span class="p">,</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">opt</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">MODEL_FPATH</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_json</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;could not write model to json&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">test</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">max_N_c</span> <span class="o">=</span> <span class="n">max_N_c</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">visualize</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">max_N_c</span> <span class="o">=</span> <span class="n">max_N_c</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">data_generator</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;test_generator&#39;</span><span class="p">]</span>
        <span class="n">label_generator</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;test_label_generator&#39;</span><span class="p">]</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">data_generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">label_generator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">zz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">zz</span> <span class="o">=</span> <span class="n">zz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">zz</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;ex</span><span class="si">{}</span><span class="s1">_output</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">FROOT</span><span class="p">,</span> <span class="s1">&#39;ex</span><span class="si">{}</span><span class="s1">.info&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ex</span><span class="p">)),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
            <span class="n">ex</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">raw_input</span><span class="p">(</span><span class="s1">&#39;Pause...&#39;</span><span class="p">)</span>
    
        <span class="n">quit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">max_N_c</span> <span class="o">=</span> <span class="n">max_N_c</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="n">WEIGHTS_FPATH</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data</span><span class="p">(</span><span class="n">max_N_c</span> <span class="o">=</span> <span class="n">max_N_c</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">ASKCOS</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../askcos.html">askcos package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../makeit.html">makeit package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rdchiral.html">rdchiral package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, ASKCOS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>